// Prisma Schema for aiMate
// PostgreSQL with pgvector extension for RAG

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector, pg_trgm]
}

// ============================================================================
// Users & Auth
// ============================================================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  passwordHash String?  @map("password_hash")
  role         String   @default("user")
  settings     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  conversations Conversation[]
  connections   Connection[]
  documents     KnowledgeDocument[]
  mcpServers    McpServer[]
  memories      Memory[]
  workspaces    Workspace[]

  @@map("users")
}

// ============================================================================
// Workspaces
// ============================================================================

model Workspace {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?
  color       String?
  icon        String?
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@map("workspaces")
}

// ============================================================================
// Conversations & Messages
// ============================================================================

model Conversation {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  workspaceId String?  @map("workspace_id")
  title       String   @default("New Conversation")
  isArchived  Boolean  @default(false) @map("is_archived")
  isPinned    Boolean  @default(false) @map("is_pinned")
  tags        Json     @default("[]")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  messages  Message[]

  @@index([userId])
  @@index([workspaceId])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           String   // user, assistant, system, tool
  content        String
  model          String?
  tokenCount     Int?     @map("token_count")
  cost           Decimal? @db.Decimal(10, 6)
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================================================
// LM Connections & Models
// ============================================================================

model Connection {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  name         String
  provider     String?  // openai, anthropic, ollama, lmstudio, etc.
  baseUrl      String   @map("base_url")
  apiKey       String?  @map("api_key") // Encrypted in production
  isEnabled    Boolean  @default(true) @map("is_enabled")
  settings     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  models Model[]

  @@map("connections")
}

model Model {
  id            String   @id @default(uuid())
  connectionId  String   @map("connection_id")
  modelId       String   @map("model_id") // e.g., "gpt-4", "llama-3.1"
  name          String
  contextWindow Int?     @map("context_window")
  capabilities  Json     @default("[]") // ["chat", "vision", "function_calling"]
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@map("models")
}

// ============================================================================
// Knowledge Base (RAG)
// ============================================================================

model KnowledgeDocument {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  filename   String
  fileType   String?  @map("file_type")
  fileSize   BigInt?  @map("file_size")
  status     String   @default("pending") // pending, processing, ready, failed
  chunkCount Int      @default(0) @map("chunk_count")
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  chunks KnowledgeChunk[]

  @@map("knowledge_documents")
}

model KnowledgeChunk {
  id         String                    @id @default(uuid())
  documentId String                    @map("document_id")
  content    String
  embedding  Unsupported("vector(384)")?
  chunkIndex Int                       @map("chunk_index")
  metadata   Json                      @default("{}")
  createdAt  DateTime                  @default(now()) @map("created_at")

  document KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("knowledge_chunks")
}

// ============================================================================
// MCP Servers (Tool Integration)
// ============================================================================

model McpServer {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  name       String
  url        String
  authType   String?  @map("auth_type") // none, api_key, oauth
  authConfig Json     @default("{}") @map("auth_config")
  isEnabled  Boolean  @default(true) @map("is_enabled")
  tools      Json     @default("[]") // Cached tool definitions
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mcp_servers")
}

// ============================================================================
// User Memories (Persistent Context)
// ============================================================================

model Memory {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  content   String
  source    String   @default("manual") // manual, auto_extracted
  category  String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("memories")
}
