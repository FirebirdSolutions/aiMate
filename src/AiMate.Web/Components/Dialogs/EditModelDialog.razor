@using AiMate.Shared.Models
@using AiMate.Core.Enums
@using AiMate.Core.Services
@inject IPermissionService PermissionService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@if (IsVisible)
{
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="Close">
        <div class="bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"
             @onclick:stopPropagation="true">

            @* Dialog Header *@
            <div class="flex items-center justify-between px-6 py-4 border-b border-[#2A2A2A] sticky top-0 bg-[#1A1A1A] z-10">
                <h3 class="text-lg font-semibold text-white">@(string.IsNullOrEmpty(Model.Id) ? "Add Model" : "Edit Model")</h3>
                <button @onclick="Close"
                        class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            @* Tabs *@
            <div class="border-b border-[#2A2A2A]">
                <div class="flex px-6">
                    <button @onclick="@(() => _activeTab = 0)"
                            class="@(_activeTab == 0 ? "border-b-2 border-purple-500 text-white" : "text-gray-400 hover:text-white") px-4 py-3 text-sm font-medium transition-all">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            General
                        </span>
                    </button>
                    <button @onclick="@(() => _activeTab = 1)"
                            class="@(_activeTab == 1 ? "border-b-2 border-purple-500 text-white" : "text-gray-400 hover:text-white") px-4 py-3 text-sm font-medium transition-all">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
                            Model Params
                        </span>
                    </button>
                    <button @onclick="@(() => _activeTab = 2)"
                            class="@(_activeTab == 2 ? "border-b-2 border-purple-500 text-white" : "text-gray-400 hover:text-white") px-4 py-3 text-sm font-medium transition-all">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5C13 2.12 11.88 1 10.5 1S8 2.12 8 3.5V5H4c-1.1 0-1.99.9-1.99 2v3.8H3.5c1.49 0 2.7 1.21 2.7 2.7s-1.21 2.7-2.7 2.7H2V20c0 1.1.9 2 2 2h3.8v-1.5c0-1.49 1.21-2.7 2.7-2.7 1.49 0 2.7 1.21 2.7 2.7V22H17c1.1 0 2-.9 2-2v-4h1.5c1.38 0 2.5-1.12 2.5-2.5S21.88 11 20.5 11z"/></svg>
                            Advanced
                        </span>
                    </button>
                </div>
            </div>

            @* Dialog Content *@
            <div class="p-6">
                @if (_activeTab == 0)
                {
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Model Name <span class="text-red-500">*</span></label>
                            <input type="text"
                                   @bind="Model.Name"
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Model ID <span class="text-red-500">*</span></label>
                            <input type="text"
                                   @bind="Model.ModelId"
                                   placeholder="e.g., gpt-4, claude-3-opus"
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Description</label>
                            <textarea @bind="Model.Description"
                                      rows="2"
                                      class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Connection</label>
                            <select @bind="Model.Connection"
                                    class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="OpenAI">OpenAI</option>
                                <option value="Anthropic">Anthropic</option>
                                <option value="Local">Local (LiteLLM)</option>
                                <option value="Custom">Custom Endpoint</option>
                            </select>
                        </div>

                        @if (_userTier == UserTier.Free || _userTier == UserTier.BYOK || HasPermission(UserPermission.AddOwnKeys))
                        {
                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">API Key</label>
                                <input type="password"
                                       @bind="Model.ApiKey"
                                       placeholder="Enter your API key"
                                       class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                <p class="text-xs text-gray-400 mt-1">Your key is encrypted and stored securely</p>
                            </div>
                        }

                        @if (HasPermission(UserPermission.AddCustomEndpoints))
                        {
                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Custom Endpoint (optional)</label>
                                <input type="text"
                                       @bind="Model.CustomEndpoint"
                                       placeholder="https://api.example.com/v1"
                                       class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                <p class="text-xs text-gray-400 mt-1">Override default endpoint URL</p>
                            </div>
                        }

                        <button @onclick="TestConnection"
                                disabled="_isTestingConnection"
                                class="flex items-center gap-2 px-4 py-2 bg-[#0F0F0F] border border-[#2A2A2A] text-purple-400 hover:bg-[#2A2A2A] disabled:text-gray-500 rounded-lg transition-all text-sm font-medium">
                            @if (_isTestingConnection)
                            {
                                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span>Testing...</span>
                            }
                            else
                            {
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <span>Test Connection</span>
                            }
                        </button>

                        @if (!string.IsNullOrEmpty(_connectionTestResult))
                        {
                            <div class="@(_connectionTestSuccess ? "bg-green-900/20 border-green-500/30 text-green-300" : "bg-red-900/20 border-red-500/30 text-red-300") border rounded-lg p-3 text-sm">
                                @_connectionTestResult
                            </div>
                        }
                    </div>
                }
                else if (_activeTab == 1)
                {
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Context Window</label>
                            <input type="number"
                                   @bind="Model.ContextWindow"
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            <p class="text-xs text-gray-400 mt-1">Maximum context length (tokens)</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Max Tokens</label>
                            <input type="number"
                                   @bind="Model.MaxTokens"
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            <p class="text-xs text-gray-400 mt-1">Maximum tokens in response</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Temperature: @Model.Temperature.ToString("F1")</label>
                            <input type="range"
                                   @bind="Model.Temperature"
                                   @bind:event="oninput"
                                   min="0"
                                   max="2"
                                   step="0.1"
                                   class="w-full h-2 bg-[#0F0F0F] rounded-lg appearance-none cursor-pointer accent-purple-600" />
                            <p class="text-xs text-gray-400 mt-1">Controls randomness. Higher = more creative</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Top P: @Model.TopP.ToString("F2")</label>
                            <input type="range"
                                   @bind="Model.TopP"
                                   @bind:event="oninput"
                                   min="0"
                                   max="1"
                                   step="0.05"
                                   class="w-full h-2 bg-[#0F0F0F] rounded-lg appearance-none cursor-pointer accent-purple-600" />
                            <p class="text-xs text-gray-400 mt-1">Nucleus sampling threshold</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Frequency Penalty: @Model.FrequencyPenalty.ToString("F1")</label>
                            <input type="range"
                                   @bind="Model.FrequencyPenalty"
                                   @bind:event="oninput"
                                   min="0"
                                   max="2"
                                   step="0.1"
                                   class="w-full h-2 bg-[#0F0F0F] rounded-lg appearance-none cursor-pointer accent-purple-600" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Presence Penalty: @Model.PresencePenalty.ToString("F1")</label>
                            <input type="range"
                                   @bind="Model.PresencePenalty"
                                   @bind:event="oninput"
                                   min="0"
                                   max="2"
                                   step="0.1"
                                   class="w-full h-2 bg-[#0F0F0F] rounded-lg appearance-none cursor-pointer accent-purple-600" />
                        </div>
                    </div>
                }
                else if (_activeTab == 2)
                {
                    <div class="space-y-4">
                        <h4 class="text-base font-semibold text-white mb-2">Capabilities</h4>
                        <p class="text-sm text-gray-400 mb-4">Enable features this model supports</p>

                        <label class="flex items-start gap-3 p-3 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg cursor-pointer hover:bg-[#2A2A2A] transition-all">
                            <input type="checkbox"
                                   @bind="Model.SupportsVision"
                                   class="mt-0.5 w-4 h-4 rounded bg-[#0F0F0F] border-[#2A2A2A] text-purple-600 focus:ring-2 focus:ring-purple-500" />
                            <div>
                                <div class="text-sm font-medium text-gray-200">Vision</div>
                                <div class="text-xs text-gray-400">Can analyze images and visual content</div>
                            </div>
                        </label>

                        <label class="flex items-start gap-3 p-3 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg cursor-pointer hover:bg-[#2A2A2A] transition-all">
                            <input type="checkbox"
                                   @bind="Model.SupportsWebSearch"
                                   class="mt-0.5 w-4 h-4 rounded bg-[#0F0F0F] border-[#2A2A2A] text-purple-600 focus:ring-2 focus:ring-purple-500" />
                            <div>
                                <div class="text-sm font-medium text-gray-200">Web Search</div>
                                <div class="text-xs text-gray-400">Can search the web for real-time information</div>
                            </div>
                        </label>

                        <label class="flex items-start gap-3 p-3 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg cursor-pointer hover:bg-[#2A2A2A] transition-all">
                            <input type="checkbox"
                                   @bind="Model.SupportsFileUpload"
                                   class="mt-0.5 w-4 h-4 rounded bg-[#0F0F0F] border-[#2A2A2A] text-purple-600 focus:ring-2 focus:ring-purple-500" />
                            <div>
                                <div class="text-sm font-medium text-gray-200">File Upload</div>
                                <div class="text-xs text-gray-400">Can process uploaded files and documents</div>
                            </div>
                        </label>

                        <label class="flex items-start gap-3 p-3 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg cursor-pointer hover:bg-[#2A2A2A] transition-all">
                            <input type="checkbox"
                                   @bind="Model.SupportsImageGeneration"
                                   class="mt-0.5 w-4 h-4 rounded bg-[#0F0F0F] border-[#2A2A2A] text-purple-600 focus:ring-2 focus:ring-purple-500" />
                            <div>
                                <div class="text-sm font-medium text-gray-200">Image Generation</div>
                                <div class="text-xs text-gray-400">Can generate images from text descriptions</div>
                            </div>
                        </label>
                    </div>
                }
            </div>

            @* Dialog Actions *@
            <div class="px-6 py-4 border-t border-[#2A2A2A] flex items-center justify-between sticky bottom-0 bg-[#1A1A1A]">
                <div>
                    @if (_userTier == UserTier.Admin && !string.IsNullOrEmpty(Model.Id))
                    {
                        <button @onclick="HandleDelete"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all text-sm font-medium">
                            Delete
                        </button>
                    }
                </div>
                <div class="flex gap-3">
                    <button @onclick="Close"
                            class="px-4 py-2 bg-transparent border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                        Cancel
                    </button>
                    <button @onclick="Save"
                            disabled="@(!IsValid())"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700 disabled:text-gray-500 text-white rounded-lg transition-all text-sm font-medium">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public AIModelDto Model { get; set; } = new();
    [Parameter] public UserTier UserTier
    {
        get => _userTier;
        set => _userTier = value;
    }
    [Parameter] public EventCallback<AIModelDto> OnSave { get; set; }
    [Parameter] public EventCallback<object> OnDelete { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private UserTier _userTier = UserTier.Free;
    private int _activeTab = 0;
    private bool _isTestingConnection = false;
    private string? _connectionTestResult;
    private bool _connectionTestSuccess = false;

    protected override void OnParametersSet()
    {
        // Initialize defaults if new model
        if (string.IsNullOrEmpty(Model.Id))
        {
            Model.ContextWindow = 8192;
            Model.MaxTokens = 4096;
            Model.Temperature = 0.7;
            Model.TopP = 1.0;
            Model.FrequencyPenalty = 0.0;
            Model.PresencePenalty = 0.0;
        }
    }

    private bool HasPermission(UserPermission permission)
    {
        return PermissionService.HasPermission(_userTier, permission);
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(Model.Name)
            && !string.IsNullOrWhiteSpace(Model.ModelId)
            && !string.IsNullOrWhiteSpace(Model.Connection);
    }

    private async Task TestConnection()
    {
        _isTestingConnection = true;
        _connectionTestResult = null;
        StateHasChanged();

        try
        {
            // IMPLEMENTATION NEEDED: Call API endpoint to test connection with actual credentials
            await Task.Delay(1500); // Simulate API call

            // Simulate success/failure
            _connectionTestSuccess = !string.IsNullOrEmpty(Model.ApiKey);
            _connectionTestResult = _connectionTestSuccess
                ? "Connection successful! Model is responding."
                : "Failed: API key is required";
        }
        catch (Exception ex)
        {
            _connectionTestSuccess = false;
            _connectionTestResult = $"Error: {ex.Message}";
        }
        finally
        {
            _isTestingConnection = false;
            StateHasChanged();
        }
    }

    private async Task Save()
    {
        if (IsValid())
        {
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync(Model);
            }
            await Close();
        }
    }

    private async Task Close()
    {
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task HandleDelete()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete this model?",
            "This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            if (OnDelete.HasDelegate)
            {
                await OnDelete.InvokeAsync(new { Action = "Delete", Model });
            }
            await Close();
        }
    }
}
