@if (IsVisible)
{
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="Cancel">
        <div class="bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"
             @onclick:stopPropagation="true">

            @* Dialog Header *@
            <div class="flex items-center justify-between px-6 py-4 border-b border-[#2A2A2A]">
                <h3 class="text-lg font-semibold text-white">Reference Conversations</h3>
                <button @onclick="Cancel"
                        class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            @* Dialog Content *@
            <div class="flex-1 overflow-y-auto p-6">
                @* Search Field *@
                <div class="mb-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <input @bind="_searchQuery"
                               @bind:event="oninput"
                               type="text"
                               placeholder="Type to search..."
                               class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg pl-10 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                    </div>
                </div>

                @* Filter Chips *@
                <div class="mb-4 flex gap-2">
                    <button @onclick="@(() => _selectedFilter = null)"
                            class="@(_selectedFilter == null ? "bg-purple-600 text-white" : "bg-[#0F0F0F] text-gray-300 hover:bg-[#2A2A2A]") px-3 py-1.5 rounded-lg text-sm font-medium border border-[#2A2A2A] transition-all">
                        All
                    </button>
                    <button @onclick="@(() => _selectedFilter = "Recent")"
                            class="@(_selectedFilter == "Recent" ? "bg-purple-600 text-white" : "bg-[#0F0F0F] text-gray-300 hover:bg-[#2A2A2A]") px-3 py-1.5 rounded-lg text-sm font-medium border border-[#2A2A2A] transition-all">
                        Recent
                    </button>
                    <button @onclick="@(() => _selectedFilter = "Archived")"
                            class="@(_selectedFilter == "Archived" ? "bg-purple-600 text-white" : "bg-[#0F0F0F] text-gray-300 hover:bg-[#2A2A2A]") px-3 py-1.5 rounded-lg text-sm font-medium border border-[#2A2A2A] transition-all">
                        Archived
                    </button>
                </div>

                @* Conversations List *@
                @if (_filteredConversations.Any())
                {
                    <div class="space-y-1">
                        @foreach (var conversation in _filteredConversations)
                        {
                            <div @onclick="@(() => ToggleConversationSelection(conversation))"
                                 class="@(conversation.IsSelected ? "bg-purple-500/10 border-purple-500/50" : "bg-[#0F0F0F] border-[#2A2A2A]") border rounded-lg p-3 cursor-pointer hover:bg-purple-500/5 transition-all">
                                <div class="flex items-start gap-3">
                                    @* Custom Checkbox *@
                                    <div class="flex items-center h-5 mt-0.5">
                                        <input type="checkbox"
                                               checked="@conversation.IsSelected"
                                               @onclick:stopPropagation
                                               @onchange="@(() => ToggleConversationSelection(conversation))"
                                               class="w-4 h-4 bg-[#0F0F0F] border-[#2A2A2A] rounded text-purple-600 focus:ring-2 focus:ring-purple-500" />
                                    </div>

                                    @* Conversation Content *@
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <p class="text-sm font-medium text-white truncate">@conversation.Title</p>
                                            @if (conversation.IsPinned)
                                            {
                                                <svg class="w-4 h-4 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M16 12V4H17V2H7V4H8V12L6 14V16H11.2V22H12.8V16H18V14L16 12Z"/>
                                                </svg>
                                            }
                                        </div>
                                        <p class="text-xs text-gray-400">
                                            @conversation.MessageCount messages Â· @GetRelativeTime(conversation.LastMessageAt)
                                        </p>
                                        @if (!string.IsNullOrEmpty(conversation.Project))
                                        {
                                            <span class="inline-block mt-1 px-2 py-0.5 bg-blue-500/20 text-blue-400 border border-blue-500/50 rounded text-xs">
                                                @conversation.Project
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"/>
                        </svg>
                        <p class="text-sm text-gray-400">
                            @(_searchQuery.Length > 0 ? "No conversations found" : "No conversations available")
                        </p>
                    </div>
                }
            </div>

            @* Dialog Actions *@
            <div class="px-6 py-4 border-t border-[#2A2A2A] flex items-center justify-end gap-3">
                <button @onclick="Cancel"
                        class="px-4 py-2 bg-transparent border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                    Cancel
                </button>
                <button @onclick="Submit"
                        disabled="@(!_conversations.Any(c => c.IsSelected))"
                        class="@(_conversations.Any(c => c.IsSelected) ? "bg-purple-600 hover:bg-purple-700" : "bg-gray-700 cursor-not-allowed") px-4 py-2 text-white rounded-lg transition-all text-sm font-medium">
                    Reference (@_conversations.Count(c => c.IsSelected))
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public List<ConversationItem>? Conversations { get; set; }

    [Parameter]
    public EventCallback<List<ConversationItem>> OnSubmit { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private string _searchQuery = string.Empty;
    private string? _selectedFilter;
    private List<ConversationItem> _conversations = new();

    private IEnumerable<ConversationItem> _filteredConversations
    {
        get
        {
            var filtered = _conversations.AsEnumerable();

            // Apply filter
            if (_selectedFilter == "Recent")
            {
                filtered = filtered.Where(c => c.LastMessageAt > DateTime.Now.AddDays(-7));
            }
            else if (_selectedFilter == "Archived")
            {
                filtered = filtered.Where(c => c.IsArchived);
            }

            // Apply search
            if (!string.IsNullOrWhiteSpace(_searchQuery))
            {
                filtered = filtered.Where(c =>
                    c.Title.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    (c.Project?.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            return filtered.OrderByDescending(c => c.LastMessageAt);
        }
    }

    protected override void OnParametersSet()
    {
        if (Conversations != null && Conversations.Any())
        {
            _conversations = Conversations;
        }
        else
        {
            // TODO: Load actual conversations from service
            _conversations = new List<ConversationItem>
            {
                new ConversationItem
                {
                    Id = 1,
                    Title = "How do I center a div in CSS?",
                    MessageCount = 8,
                    LastMessageAt = DateTime.Now.AddHours(-2),
                    IsPinned = true,
                    Project = null
                },
                new ConversationItem
                {
                    Id = 2,
                    Title = "Explain React hooks",
                    MessageCount = 15,
                    LastMessageAt = DateTime.Now.AddDays(-1),
                    IsPinned = false,
                    Project = "Website Redesign"
                },
                new ConversationItem
                {
                    Id = 3,
                    Title = "TypeScript best practices",
                    MessageCount = 23,
                    LastMessageAt = DateTime.Now.AddDays(-3),
                    IsPinned = true,
                    Project = "Mobile App"
                },
                new ConversationItem
                {
                    Id = 4,
                    Title = "API design patterns",
                    MessageCount = 12,
                    LastMessageAt = DateTime.Now.AddDays(-5),
                    IsPinned = false,
                    Project = "API Gateway"
                },
                new ConversationItem
                {
                    Id = 5,
                    Title = "Old conversation about React",
                    MessageCount = 5,
                    LastMessageAt = DateTime.Now.AddDays(-45),
                    IsPinned = false,
                    IsArchived = true,
                    Project = null
                }
            };
        }
    }

    private void ToggleConversationSelection(ConversationItem conversation)
    {
        conversation.IsSelected = !conversation.IsSelected;
        StateHasChanged();
    }

    private string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalHours < 1)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalDays < 1)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)}w ago";

        return dateTime.ToString("MMM dd, yyyy");
    }

    private async Task Submit()
    {
        var selectedConversations = _conversations.Where(c => c.IsSelected).ToList();
        await OnSubmit.InvokeAsync(selectedConversations);
        await Close();
    }

    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
        await Close();
    }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(IsVisible);
    }

    public class ConversationItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public int MessageCount { get; set; }
        public DateTime LastMessageAt { get; set; }
        public bool IsPinned { get; set; }
        public bool IsArchived { get; set; }
        public string? Project { get; set; }
        public bool IsSelected { get; set; }
    }
}
