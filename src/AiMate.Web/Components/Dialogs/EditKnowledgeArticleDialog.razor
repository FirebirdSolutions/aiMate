@using AiMate.Shared.Models
@using AiMate.Web.Store.Knowledge
@using Fluxor
@inject IState<KnowledgeState> KnowledgeState
@inject IDispatcher Dispatcher
@inject ISnackbar Snackbar

@if (IsVisible)
{
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="Close">
        <div class="bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"
             @onclick:stopPropagation="true">

            @* Dialog Header *@
            <div class="flex items-center justify-between px-6 py-4 border-b border-[#2A2A2A] sticky top-0 bg-[#1A1A1A] z-10">
                <h3 class="text-lg font-semibold text-white">@(_isEditMode ? "Edit Article" : "Create Article")</h3>
                <button @onclick="Close"
                        class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            @* Tabs *@
            <div class="border-b border-[#2A2A2A]">
                <div class="flex px-6">
                    <button @onclick="@(() => _activeTab = 0)"
                            class="@(_activeTab == 0 ? "border-b-2 border-purple-500 text-white" : "text-gray-400 hover:text-white") px-4 py-3 text-sm font-medium transition-all">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                            Basic Info
                        </span>
                    </button>
                    <button @onclick="@(() => _activeTab = 1)"
                            class="@(_activeTab == 1 ? "border-b-2 border-purple-500 text-white" : "text-gray-400 hover:text-white") px-4 py-3 text-sm font-medium transition-all">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                            Organization
                        </span>
                    </button>
                    <button @onclick="@(() => _activeTab = 2)"
                            class="@(_activeTab == 2 ? "border-b-2 border-purple-500 text-white" : "text-gray-400 hover:text-white") px-4 py-3 text-sm font-medium transition-all">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                            Settings
                        </span>
                    </button>
                </div>
            </div>

            @* Dialog Content *@
            <div class="p-6">
                @if (_activeTab == 0)
                {
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Title <span class="text-red-500">*</span></label>
                            <input type="text"
                                   @bind="_article.Title"
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Summary</label>
                            <textarea @bind="_article.Summary"
                                      rows="2"
                                      placeholder="Brief description of the article"
                                      class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Type <span class="text-red-500">*</span></label>
                                <select @bind="_article.Type"
                                        class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="Article">Article</option>
                                    <option value="Guide">Guide</option>
                                    <option value="Reference">Reference</option>
                                    <option value="Tutorial">Tutorial</option>
                                    <option value="FAQ">FAQ</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Content Type</label>
                                <select @bind="_article.ContentType"
                                        class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="Markdown">Markdown</option>
                                    <option value="HTML">HTML</option>
                                    <option value="Text">Plain Text</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Content <span class="text-red-500">*</span></label>
                            <textarea @bind="_article.Content"
                                      rows="12"
                                      class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono"></textarea>
                            <p class="text-xs text-gray-400 mt-1">@(_article.ContentType == "Markdown" ? "Supports Markdown formatting" : "")</p>
                        </div>
                    </div>
                }
                else if (_activeTab == 1)
                {
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Collection</label>
                                <input type="text"
                                       @bind="_article.Collection"
                                       list="collections-list"
                                       placeholder="Group articles into collections"
                                       class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                <datalist id="collections-list">
                                    @foreach (var collection in KnowledgeState.Value.Collections)
                                    {
                                        <option value="@collection">@collection</option>
                                    }
                                </datalist>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Category</label>
                                <input type="text"
                                       @bind="_article.Category"
                                       list="categories-list"
                                       class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                <datalist id="categories-list">
                                    @foreach (var category in KnowledgeState.Value.Categories)
                                    {
                                        <option value="@category">@category</option>
                                    }
                                </datalist>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Tags</label>
                            <div class="flex flex-wrap gap-2 mb-2">
                                @foreach (var tag in _article.Tags)
                                {
                                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-600/20 border border-purple-500/30 text-purple-300 rounded text-xs">
                                        @tag
                                        <button type="button" @onclick="@(() => RemoveTag(tag))" class="hover:text-purple-100">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </span>
                                }
                            </div>
                            <input type="text"
                                   @bind="_currentTag"
                                   @onkeydown="@(async (e) => { if (e.Key == "Enter") { AddTag(_currentTag); _currentTag = ""; } })"
                                   list="tags-list"
                                   placeholder="Type and press Enter to add tags"
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            <datalist id="tags-list">
                                @foreach (var tag in KnowledgeState.Value.AllTags)
                                {
                                    <option value="@tag">@tag</option>
                                }
                            </datalist>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Source</label>
                            <input type="text"
                                   @bind="_article.Source"
                                   placeholder="Original source or reference URL"
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>
                    </div>
                }
                else if (_activeTab == 2)
                {
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Visibility</label>
                                <select @bind="_article.Visibility"
                                        class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="Private">üîí Private - Only me</option>
                                    <option value="Group">üë• Group - My team</option>
                                    <option value="Organization">üè¢ Organization - All org users</option>
                                    <option value="Public">üåç Public - Everyone</option>
                                </select>
                            </div>

                            <div class="flex items-center">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox"
                                           @bind="_article.IsPublished"
                                           class="w-4 h-4 rounded bg-[#0F0F0F] border-[#2A2A2A] text-green-600 focus:ring-2 focus:ring-green-500" />
                                    <span class="text-sm text-gray-200">Published</span>
                                </label>
                                <p class="text-xs text-gray-400 ml-6">Make article visible to others</p>
                            </div>
                        </div>

                        <hr class="border-[#2A2A2A]" />

                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex items-start gap-3 p-3 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg cursor-pointer hover:bg-[#2A2A2A] transition-all">
                                <input type="checkbox"
                                       @bind="_article.IsFeatured"
                                       class="mt-0.5 w-4 h-4 rounded bg-[#0F0F0F] border-[#2A2A2A] text-yellow-600 focus:ring-2 focus:ring-yellow-500" />
                                <div>
                                    <div class="text-sm font-medium text-gray-200">Featured</div>
                                    <div class="text-xs text-gray-400">Highlight this article</div>
                                </div>
                            </label>

                            <label class="flex items-start gap-3 p-3 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg cursor-pointer hover:bg-[#2A2A2A] transition-all">
                                <input type="checkbox"
                                       @bind="_article.IsVerified"
                                       class="mt-0.5 w-4 h-4 rounded bg-[#0F0F0F] border-[#2A2A2A] text-green-600 focus:ring-2 focus:ring-green-500" />
                                <div>
                                    <div class="text-sm font-medium text-gray-200">Verified</div>
                                    <div class="text-xs text-gray-400">Mark as verified/trusted content</div>
                                </div>
                            </label>
                        </div>

                        @if (_isEditMode)
                        {
                            <hr class="border-[#2A2A2A]" />
                            <div>
                                <h4 class="text-base font-semibold text-white mb-3">Statistics</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                                        <div class="flex items-center gap-2 text-blue-400 mb-1">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                            <span class="text-xs text-gray-400">Views</span>
                                        </div>
                                        <div class="text-xl font-semibold text-white">@_article.ViewCount.ToString("N0")</div>
                                    </div>
                                    <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                                        <div class="flex items-center gap-2 text-green-400 mb-1">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                                            <span class="text-xs text-gray-400">References</span>
                                        </div>
                                        <div class="text-xl font-semibold text-white">@_article.ReferenceCount.ToString("N0")</div>
                                    </div>
                                    <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                                        <div class="flex items-center gap-2 text-purple-400 mb-1">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/></svg>
                                            <span class="text-xs text-gray-400">Upvotes</span>
                                        </div>
                                        <div class="text-xl font-semibold text-white">@_article.UpvoteCount.ToString("N0")</div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="bg-red-900/20 border border-red-500/30 text-red-300 rounded-lg p-3 text-sm mt-4">
                        @_errorMessage
                    </div>
                }
            </div>

            @* Dialog Actions *@
            <div class="px-6 py-4 border-t border-[#2A2A2A] flex items-center justify-end gap-3 sticky bottom-0 bg-[#1A1A1A]">
                <button @onclick="Close"
                        class="px-4 py-2 bg-transparent border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                    Cancel
                </button>
                <button @onclick="Save"
                        disabled="@KnowledgeState.Value.IsSaving"
                        class="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700 disabled:text-gray-500 text-white rounded-lg transition-all text-sm font-medium">
                    @if (KnowledgeState.Value.IsSaving)
                    {
                        <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        <span>@(_isEditMode ? "Update" : "Create") Article</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public KnowledgeArticleDto? Article { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private KnowledgeArticleDto _article = new();
    private bool _isEditMode;
    private string? _errorMessage;
    private string _currentTag = string.Empty;
    private int _activeTab = 0;

    protected override void OnParametersSet()
    {
        if (Article != null)
        {
            _article = new KnowledgeArticleDto
            {
                Id = Article.Id,
                Title = Article.Title,
                Content = Article.Content,
                ContentType = Article.ContentType,
                Summary = Article.Summary,
                Type = Article.Type,
                Tags = new List<string>(Article.Tags),
                Collection = Article.Collection,
                Category = Article.Category,
                Source = Article.Source,
                Visibility = Article.Visibility,
                IsPublished = Article.IsPublished,
                IsFeatured = Article.IsFeatured,
                IsVerified = Article.IsVerified,
                ViewCount = Article.ViewCount,
                ReferenceCount = Article.ReferenceCount,
                UpvoteCount = Article.UpvoteCount,
                OwnerId = Article.OwnerId,
                CreatedAt = Article.CreatedAt,
                UpdatedAt = Article.UpdatedAt,
                PublishedAt = Article.PublishedAt,
                LastViewedAt = Article.LastViewedAt
            };
            _isEditMode = true;
        }
        else
        {
            _article = new KnowledgeArticleDto
            {
                Type = "Article",
                ContentType = "Markdown",
                Visibility = "Private",
                IsPublished = true
            };
            _isEditMode = false;
        }
    }

    private void AddTag(string value)
    {
        if (!string.IsNullOrWhiteSpace(value) && !_article.Tags.Contains(value))
        {
            _article.Tags.Add(value);
        }
    }

    private void RemoveTag(string tag)
    {
        _article.Tags.Remove(tag);
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(_article.Title) || string.IsNullOrWhiteSpace(_article.Content))
        {
            _errorMessage = "Title and content are required";
            return;
        }

        _errorMessage = null;

        try
        {
            if (_isEditMode)
            {
                Dispatcher.Dispatch(new UpdateArticleAction(_article.Id, _article));
            }
            else
            {
                Dispatcher.Dispatch(new CreateArticleAction(_article));
            }

            // Wait a moment for the state to update
            await Task.Delay(100);

            if (string.IsNullOrEmpty(KnowledgeState.Value.Error))
            {
                Snackbar.Add(
                    _isEditMode ? "Article updated successfully" : "Article created successfully",
                    Severity.Success
                );
                await Close();
            }
            else
            {
                _errorMessage = KnowledgeState.Value.Error;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task Close()
    {
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
        await IsVisibleChanged.InvokeAsync(false);
    }
}
