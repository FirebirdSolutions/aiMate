@using AiMate.Shared.Models
@using AiMate.Core.Enums
@using AiMate.Core.Services
@inject IPermissionService PermissionService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@if (IsVisible)
{
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="Close">
        <div class="bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto"
             @onclick:stopPropagation="true">

            @* Dialog Header *@
            <div class="flex items-center justify-between px-6 py-4 border-b border-[#2A2A2A] sticky top-0 bg-[#1A1A1A] z-10">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-semibold text-white">@(string.IsNullOrEmpty(Connection.Id) ? "Add Connection" : "Edit Connection")</h3>
                    @if (HasPermission(UserPermission.AddCustomEndpoints))
                    {
                        <span class="px-2 py-1 bg-blue-600/20 border border-blue-500/30 text-blue-300 rounded text-xs">
                            @Connection.Type
                        </span>
                    }
                </div>
                <button @onclick="Close"
                        class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            @* Dialog Content *@
            <div class="p-6 space-y-6">
                @* Basic Info *@
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-2">Connection Name <span class="text-red-500">*</span></label>
                        <input type="text"
                               @bind="Connection.Name"
                               placeholder="Friendly name for this connection"
                               class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                    </div>

                    @* Connection Type Toggle *@
                    @if (HasPermission(UserPermission.AddCustomEndpoints))
                    {
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-200">Connection Type</span>
                            <div class="flex gap-2">
                                <button type="button"
                                        @onclick="@(() => Connection.Type = "Local")"
                                        class="@(Connection.Type == "Local" ? "bg-purple-600 text-white" : "bg-[#0F0F0F] text-gray-400") px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-purple-700">
                                    Local
                                </button>
                                <button type="button"
                                        @onclick="@(() => Connection.Type = "Cloud")"
                                        class="@(Connection.Type == "Cloud" ? "bg-purple-600 text-white" : "bg-[#0F0F0F] text-gray-400") px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-purple-700">
                                    Cloud
                                </button>
                            </div>
                        </div>
                    }

                    @* URL *@
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-2">URL <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                            </span>
                            <input type="text"
                                   @bind="Connection.Url"
                                   placeholder="https://api.openai.com/v1"
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg pl-10 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>
                    </div>

                    @* Provider Type *@
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-2">Provider Type</label>
                        <select @bind="Connection.ProviderType"
                                class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="OpenAI">üß† OpenAI</option>
                            <option value="Anthropic">ü§ñ Anthropic</option>
                            <option value="Ollama">üíª Ollama (Local)</option>
                            <option value="LiteLLM">üîó LiteLLM</option>
                            <option value="Custom">‚öôÔ∏è Custom</option>
                        </select>
                    </div>
                </div>

                @* Authentication *@
                <div class="border-t border-[#2A2A2A] pt-6 space-y-4">
                    <h4 class="text-base font-semibold text-white">Authentication</h4>

                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-2">Auth Type</label>
                        <select @bind="Connection.Auth"
                                class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="None">None</option>
                            <option value="Bearer">Bearer Token</option>
                            <option value="ApiKey">API Key</option>
                            <option value="OAuth">OAuth 2.0</option>
                        </select>
                    </div>

                    @if (Connection.Auth != "None")
                    {
                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">@GetAuthLabel()</label>
                            <div class="relative">
                                <input type="@(_showPassword ? "text" : "password")"
                                       @bind="Connection.AuthToken"
                                       placeholder="Enter your authentication token"
                                       class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                <button type="button"
                                        @onclick="@(() => _showPassword = !_showPassword)"
                                        class="absolute right-3 top-2.5 text-gray-400 hover:text-white">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        @if (_showPassword)
                                        {
                                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                        }
                                        else
                                        {
                                            <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                                        }
                                    </svg>
                                </button>
                            </div>
                        </div>
                    }
                </div>

                @* Advanced *@
                @if (HasPermission(UserPermission.AddCustomEndpoints))
                {
                    <div class="border-t border-[#2A2A2A] pt-6">
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer list-none">
                                <h4 class="text-base font-semibold text-white">Advanced Settings</h4>
                                <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 9l-7 7-7-7"/>
                                </svg>
                            </summary>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-200 mb-2">Custom Headers (JSON)</label>
                                    <textarea @bind="Connection.Headers"
                                              rows="3"
                                              placeholder='{"X-Custom-Header": "value"}'
                                              class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono"></textarea>
                                    <p class="text-xs text-gray-400 mt-1">Additional HTTP headers in JSON format</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-200 mb-2">Prefix ID (optional)</label>
                                    <input type="text"
                                           @bind="Connection.PrefixId"
                                           placeholder="my-org"
                                           class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    <p class="text-xs text-gray-400 mt-1">Prefix for model IDs</p>
                                </div>
                            </div>
                        </details>
                    </div>
                }

                @* Model IDs *@
                <div class="border-t border-[#2A2A2A] pt-6 space-y-4">
                    <div>
                        <h4 class="text-base font-semibold text-white">Model IDs</h4>
                        <p class="text-xs text-gray-400 mt-1">Leave empty to auto-discover from endpoint</p>
                    </div>

                    @foreach (var (modelId, index) in Connection.ModelIds.Select((m, i) => (m, i)))
                    {
                        <div class="flex gap-2">
                            <input type="text"
                                   value="@modelId"
                                   @oninput="@((ChangeEventArgs e) => UpdateModelId(index, e.Value?.ToString() ?? ""))"
                                   placeholder="gpt-4, claude-3-opus, etc."
                                   class="flex-1 bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            <button type="button"
                                    @onclick="@(() => RemoveModelId(index))"
                                    class="px-3 py-2 bg-red-600/20 border border-red-500/30 text-red-300 hover:bg-red-600/30 rounded-lg transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    }

                    <button type="button"
                            @onclick="AddModelId"
                            class="flex items-center gap-2 px-4 py-2 bg-[#0F0F0F] border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Model ID
                    </button>
                </div>

                @* Tags *@
                <div class="border-t border-[#2A2A2A] pt-6 space-y-4">
                    <h4 class="text-base font-semibold text-white">Tags</h4>
                    <div class="flex flex-wrap gap-2">
                        @foreach (var (tag, index) in Connection.Tags.Select((t, i) => (t, i)))
                        {
                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-600/20 border border-purple-500/30 text-purple-300 rounded text-xs">
                                @tag
                                <button type="button" @onclick="@(() => RemoveTag(index))" class="hover:text-purple-100">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </span>
                        }
                    </div>
                    <div class="flex gap-2">
                        <input type="text"
                               @bind="_newTag"
                               @onkeydown="HandleTagKeyPress"
                               placeholder="Add tag..."
                               class="flex-1 bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        <button type="button"
                                @onclick="AddTag"
                                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all text-sm font-medium">
                            Add
                        </button>
                    </div>
                </div>

                @* Visibility & Sharing *@
                @if (HasPermission(UserPermission.ShareConnections) || UserTier == UserTier.Admin)
                {
                    <div class="border-t border-[#2A2A2A] pt-6 space-y-4">
                        <h4 class="text-base font-semibold text-white">Visibility & Sharing</h4>

                        <div>
                            <label class="block text-sm font-medium text-gray-200 mb-2">Visibility</label>
                            <select @bind="Connection.Visibility"
                                    class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="Private">üîí Private</option>
                                @if (HasPermission(UserPermission.ShareConnections))
                                {
                                    <option value="Group">üë• Group</option>
                                }
                                @if (UserTier == UserTier.Admin)
                                {
                                    <option value="Organization">üè¢ Organization</option>
                                    <option value="Public">üåç Public</option>
                                }
                            </select>
                            <p class="text-xs text-gray-400 mt-1">@GetVisibilityHelperText()</p>
                        </div>

                        @if (Connection.Visibility == "Group")
                        {
                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Groups</label>
                                <p class="text-xs text-gray-400 mb-2">Select groups that can access this connection</p>
                                <div class="space-y-2">
                                    @foreach (var group in new[] { "engineering", "marketing", "sales", "support" })
                                    {
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox"
                                                   checked="@Connection.AllowedGroups.Contains(group)"
                                                   @onchange="@((ChangeEventArgs e) => ToggleGroup(group, (bool)(e.Value ?? false)))"
                                                   class="w-4 h-4 rounded bg-[#0F0F0F] border-[#2A2A2A] text-purple-600 focus:ring-2 focus:ring-purple-500" />
                                            <span class="text-sm text-gray-200 capitalize">@group</span>
                                        </label>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }

                @* Import/Export *@
                @if (UserTier == UserTier.Admin || HasPermission(UserPermission.ManageOwnConnections))
                {
                    <div class="border-t border-[#2A2A2A] pt-6">
                        <div class="flex gap-2">
                            <button type="button"
                                    @onclick="ImportConnection"
                                    class="flex items-center gap-2 px-4 py-2 bg-[#0F0F0F] border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                                Import
                            </button>
                            <button type="button"
                                    @onclick="ExportConnection"
                                    class="flex items-center gap-2 px-4 py-2 bg-[#0F0F0F] border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>
                }
            </div>

            @* Dialog Actions *@
            <div class="px-6 py-4 border-t border-[#2A2A2A] flex items-center justify-between sticky bottom-0 bg-[#1A1A1A]">
                <div>
                    @if (UserTier == UserTier.Admin && !string.IsNullOrEmpty(Connection.Id))
                    {
                        <button @onclick="HandleDelete"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all text-sm font-medium">
                            Delete
                        </button>
                    }
                </div>
                <div class="flex gap-3">
                    <button @onclick="Close"
                            class="px-4 py-2 bg-transparent border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                        Cancel
                    </button>
                    <button @onclick="Save"
                            disabled="@(!IsValid())"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700 disabled:text-gray-500 text-white rounded-lg transition-all text-sm font-medium">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public ProviderConnectionDto Connection { get; set; } = new();
    [Parameter] public UserTier UserTier { get; set; } = UserTier.Free;
    [Parameter] public EventCallback<ProviderConnectionDto> OnSave { get; set; }
    [Parameter] public EventCallback<object> OnDelete { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private bool _showPassword = false;
    private string _newTag = string.Empty;

    protected override void OnParametersSet()
    {
        // Initialize defaults
        if (string.IsNullOrEmpty(Connection.Id))
        {
            Connection.Type = "Cloud";
            Connection.Auth = "ApiKey";
            Connection.Visibility = "Private";
            Connection.ProviderType = "OpenAI";
        }
    }

    private bool HasPermission(UserPermission permission)
    {
        return PermissionService.HasPermission(UserTier, permission);
    }

    private string GetAuthLabel()
    {
        return Connection.Auth switch
        {
            "Bearer" => "Bearer Token",
            "ApiKey" => "API Key",
            "OAuth" => "OAuth Token",
            _ => "Auth Token"
        };
    }

    private string GetVisibilityHelperText()
    {
        return Connection.Visibility switch
        {
            "Private" => "Only you can use this connection",
            "Group" => "Only selected groups can use",
            "Organization" => "All users in your organization",
            "Public" => "Available to all platform users",
            _ => ""
        };
    }

    private void AddModelId()
    {
        Connection.ModelIds.Add(string.Empty);
        StateHasChanged();
    }

    private void UpdateModelId(int index, string value)
    {
        if (index >= 0 && index < Connection.ModelIds.Count)
        {
            Connection.ModelIds[index] = value;
        }
    }

    private void RemoveModelId(int index)
    {
        if (index >= 0 && index < Connection.ModelIds.Count)
        {
            Connection.ModelIds.RemoveAt(index);
            StateHasChanged();
        }
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(_newTag) && !Connection.Tags.Contains(_newTag))
        {
            Connection.Tags.Add(_newTag.Trim());
            _newTag = string.Empty;
            StateHasChanged();
        }
    }

    private void RemoveTag(int index)
    {
        if (index >= 0 && index < Connection.Tags.Count)
        {
            Connection.Tags.RemoveAt(index);
            StateHasChanged();
        }
    }

    private void HandleTagKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddTag();
        }
    }

    private void ToggleGroup(string group, bool isChecked)
    {
        if (isChecked && !Connection.AllowedGroups.Contains(group))
        {
            Connection.AllowedGroups.Add(group);
        }
        else if (!isChecked && Connection.AllowedGroups.Contains(group))
        {
            Connection.AllowedGroups.Remove(group);
        }
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(Connection.Name)
            && !string.IsNullOrWhiteSpace(Connection.Url)
            && !string.IsNullOrWhiteSpace(Connection.ProviderType);
    }

    private async Task ImportConnection()
    {
        Snackbar.Add("Import functionality coming soon", Severity.Info);
        await Task.CompletedTask;
    }

    private async Task ExportConnection()
    {
        Snackbar.Add("Exported to clipboard", Severity.Success);
        await Task.CompletedTask;
    }

    private async Task Save()
    {
        if (IsValid())
        {
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync(Connection);
            }
            await Close();
        }
    }

    private async Task Close()
    {
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task HandleDelete()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete this connection?",
            "This will also remove all associated models.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            if (OnDelete.HasDelegate)
            {
                await OnDelete.InvokeAsync(new { Action = "Delete", Connection });
            }
            await Close();
        }
    }
}
