@if (IsVisible)
{
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="Cancel">
        <div class="bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"
             @onclick:stopPropagation="true">

            @* Dialog Header *@
            <div class="flex items-center justify-between px-6 py-4 border-b border-[#2A2A2A]">
                <h3 class="text-lg font-semibold text-white">Attach Knowledge</h3>
                <button @onclick="Cancel"
                        class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            @* Tabs *@
            <div class="border-b border-[#2A2A2A]">
                <div class="flex px-6">
                    <button @onclick="@(() => _activeTab = "knowledge")"
                            class="@(_activeTab == "knowledge" ? "border-purple-500 text-purple-400" : "border-transparent text-gray-400 hover:text-gray-300") flex items-center gap-2 px-4 py-3 border-b-2 font-medium text-sm transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/>
                        </svg>
                        Knowledge
                    </button>
                    <button @onclick="@(() => _activeTab = "collections")"
                            class="@(_activeTab == "collections" ? "border-purple-500 text-purple-400" : "border-transparent text-gray-400 hover:text-gray-300") flex items-center gap-2 px-4 py-3 border-b-2 font-medium text-sm transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/>
                        </svg>
                        Collections
                    </button>
                </div>
            </div>

            @* Dialog Content *@
            <div class="flex-1 overflow-y-auto p-6">
                @if (_activeTab == "knowledge")
                {
                    @* Knowledge Tab *@
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            <input @bind="_searchQuery"
                                   @bind:event="oninput"
                                   type="text"
                                   placeholder="Type to search..."
                                   class="w-full bg-[#0F0F0F] border border-[#2A2A2A] text-white rounded-lg pl-10 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>
                    </div>

                    @if (_filteredKnowledge.Any())
                    {
                        <div class="space-y-1">
                            @foreach (var item in _filteredKnowledge)
                            {
                                <div @onclick="@(() => ToggleKnowledgeSelection(item))"
                                     class="@(item.IsSelected ? "bg-purple-500/10 border-purple-500/50" : "bg-[#0F0F0F] border-[#2A2A2A]") border rounded-lg p-3 cursor-pointer hover:bg-purple-500/5 transition-all">
                                    <div class="flex items-start gap-3">
                                        <div class="flex items-center h-5 mt-0.5">
                                            <input type="checkbox"
                                                   checked="@item.IsSelected"
                                                   @onclick:stopPropagation
                                                   @onchange="@(() => ToggleKnowledgeSelection(item))"
                                                   class="w-4 h-4 bg-[#0F0F0F] border-[#2A2A2A] rounded text-purple-600 focus:ring-2 focus:ring-purple-500" />
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-white truncate">@item.Title</p>
                                            <p class="text-xs text-gray-400 mt-1">
                                                @item.Category Â· @item.UpdatedAt.ToString("MMM dd, yyyy")
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/>
                            </svg>
                            <p class="text-sm text-gray-400">
                                @(_searchQuery.Length > 0 ? "No knowledge articles found" : "No knowledge articles available")
                            </p>
                        </div>
                    }
                }
                else
                {
                    @* Collections Tab *@
                    @if (_collections.Any())
                    {
                        <div class="space-y-1">
                            @foreach (var collection in _collections)
                            {
                                <div @onclick="@(() => ToggleCollectionSelection(collection))"
                                     class="@(collection.IsSelected ? "bg-purple-500/10 border-purple-500/50" : "bg-[#0F0F0F] border-[#2A2A2A]") border rounded-lg p-3 cursor-pointer hover:bg-purple-500/5 transition-all">
                                    <div class="flex items-start gap-3">
                                        <div class="flex items-center h-5 mt-0.5">
                                            <input type="checkbox"
                                                   checked="@collection.IsSelected"
                                                   @onclick:stopPropagation
                                                   @onchange="@(() => ToggleCollectionSelection(collection))"
                                                   class="w-4 h-4 bg-[#0F0F0F] border-[#2A2A2A] rounded text-purple-600 focus:ring-2 focus:ring-purple-500" />
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-white truncate">@collection.Name</p>
                                            <p class="text-xs text-gray-400 mt-1">@collection.ItemCount items</p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <path d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/>
                            </svg>
                            <p class="text-sm text-gray-400">No collections available</p>
                        </div>
                    }
                }
            </div>

            @* Dialog Actions *@
            <div class="px-6 py-4 border-t border-[#2A2A2A] flex items-center justify-end gap-3">
                <button @onclick="Cancel"
                        class="px-4 py-2 bg-transparent border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                    Cancel
                </button>
                <button @onclick="Submit"
                        disabled="@(!HasSelection())"
                        class="@(HasSelection() ? "bg-purple-600 hover:bg-purple-700" : "bg-gray-700 cursor-not-allowed") px-4 py-2 text-white rounded-lg transition-all text-sm font-medium">
                    Attach (@GetSelectionCount())
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public List<KnowledgeItem>? Knowledge { get; set; }

    [Parameter]
    public List<CollectionItem>? Collections { get; set; }

    [Parameter]
    public EventCallback<KnowledgeSelection> OnSubmit { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private string _activeTab = "knowledge";
    private string _searchQuery = string.Empty;
    private List<KnowledgeItem> _knowledge = new();
    private List<CollectionItem> _collections = new();

    private IEnumerable<KnowledgeItem> _filteredKnowledge => string.IsNullOrWhiteSpace(_searchQuery)
        ? _knowledge
        : _knowledge.Where(k => k.Title.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
                               k.Category.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase));

    protected override void OnParametersSet()
    {
        if (Knowledge != null && Knowledge.Any())
        {
            _knowledge = Knowledge;
        }
        else
        {
            // TODO: Load actual knowledge from service
            _knowledge = new List<KnowledgeItem>
            {
                new KnowledgeItem
                {
                    Id = 1,
                    Title = "React Documentation - Hooks & Context API",
                    Category = "Frontend Development",
                    UpdatedAt = DateTime.Now.AddDays(-3)
                },
                new KnowledgeItem
                {
                    Id = 2,
                    Title = "TypeScript Handbook - Advanced Types",
                    Category = "Frontend Development",
                    UpdatedAt = DateTime.Now.AddDays(-7)
                },
                new KnowledgeItem
                {
                    Id = 3,
                    Title = "REST API Authentication - OAuth 2.0 Guide",
                    Category = "API Documentation",
                    UpdatedAt = DateTime.Now.AddDays(-5)
                },
                new KnowledgeItem
                {
                    Id = 4,
                    Title = "Design System Specification v2.0",
                    Category = "Design Specs",
                    UpdatedAt = DateTime.Now.AddDays(-15)
                }
            };
        }

        if (Collections != null && Collections.Any())
        {
            _collections = Collections;
        }
        else
        {
            _collections = new List<CollectionItem>
            {
                new CollectionItem { Id = 1, Name = "API Documentation", ItemCount = 15 },
                new CollectionItem { Id = 2, Name = "Meeting Notes", ItemCount = 8 },
                new CollectionItem { Id = 3, Name = "Design Specs", ItemCount = 12 },
                new CollectionItem { Id = 4, Name = "Frontend Development", ItemCount = 23 }
            };
        }
    }

    private void ToggleKnowledgeSelection(KnowledgeItem item)
    {
        item.IsSelected = !item.IsSelected;
        StateHasChanged();
    }

    private void ToggleCollectionSelection(CollectionItem collection)
    {
        collection.IsSelected = !collection.IsSelected;
        StateHasChanged();
    }

    private bool HasSelection() =>
        _knowledge.Any(k => k.IsSelected) || _collections.Any(c => c.IsSelected);

    private int GetSelectionCount() =>
        _knowledge.Count(k => k.IsSelected) + _collections.Count(c => c.IsSelected);

    private async Task Submit()
    {
        var result = new KnowledgeSelection
        {
            Knowledge = _knowledge.Where(k => k.IsSelected).ToList(),
            Collections = _collections.Where(c => c.IsSelected).ToList()
        };
        await OnSubmit.InvokeAsync(result);
        await Close();
    }

    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
        await Close();
    }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(IsVisible);
    }

    public class KnowledgeItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public DateTime UpdatedAt { get; set; }
        public bool IsSelected { get; set; }
    }

    public class CollectionItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public int ItemCount { get; set; }
        public bool IsSelected { get; set; }
    }

    public class KnowledgeSelection
    {
        public List<KnowledgeItem> Knowledge { get; set; } = new();
        public List<CollectionItem> Collections { get; set; } = new();
    }
}
