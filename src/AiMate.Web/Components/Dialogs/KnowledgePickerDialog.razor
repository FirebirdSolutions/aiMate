@inject IDialogService DialogService

<MudDialog>
    <DialogContent>
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4">
            <MudTabPanel Text="Knowledge" Icon="@Icons.Material.Filled.Article">
                <div class="mb-4">
                    <MudTextField @bind-Value="_searchQuery"
                                 Label="Search knowledge base"
                                 Placeholder="Type to search..."
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 FullWidth="true"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Search" />
                </div>

                @if (_filteredKnowledge.Any())
                {
                    <MudList Clickable="true" Dense="true" Class="max-h-96 overflow-y-auto">
                        @foreach (var item in _filteredKnowledge)
                        {
                            <MudListItem OnClick="@(() => ToggleKnowledgeSelection(item))"
                                        Class="@(IsKnowledgeSelected(item) ? "bg-primary/10" : "")">
                                <div class="flex items-center gap-3">
                                    <MudCheckBox @bind-Checked="@item.IsSelected"
                                                Color="Color.Primary"
                                                Dense="true" />
                                    <div class="flex-1">
                                        <MudText Typo="Typo.body2" Class="font-medium">@item.Title</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @item.Category Â· @item.UpdatedAt.ToString("MMM dd, yyyy")
                                        </MudText>
                                    </div>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <div class="text-center py-8">
                        <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                            @(_searchQuery.Length > 0 ? "No knowledge articles found" : "No knowledge articles available")
                        </MudText>
                    </div>
                }
            </MudTabPanel>

            <MudTabPanel Text="Collections" Icon="@Icons.Material.Filled.Folder">
                @if (_collections.Any())
                {
                    <MudList Clickable="true" Dense="true" Class="max-h-96 overflow-y-auto">
                        @foreach (var collection in _collections)
                        {
                            <MudListItem OnClick="@(() => ToggleCollectionSelection(collection))"
                                        Class="@(IsCollectionSelected(collection) ? "bg-primary/10" : "")">
                                <div class="flex items-center gap-3">
                                    <MudCheckBox @bind-Checked="@collection.IsSelected"
                                                Color="Color.Primary"
                                                Dense="true" />
                                    <div class="flex-1">
                                        <MudText Typo="Typo.body2" Class="font-medium">@collection.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @collection.ItemCount items
                                        </MudText>
                                    </div>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <div class="text-center py-8">
                        <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                            No collections available
                        </MudText>
                    </div>
                }
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   OnClick="Submit"
                   Disabled="@(!HasSelection())">
            Attach (@GetSelectionCount())
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = default!;

    private string _searchQuery = string.Empty;
    private List<KnowledgeItem> _knowledge = new();
    private List<CollectionItem> _collections = new();

    private IEnumerable<KnowledgeItem> _filteredKnowledge => string.IsNullOrWhiteSpace(_searchQuery)
        ? _knowledge
        : _knowledge.Where(k => k.Title.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
                               k.Category.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        // TODO: Load actual knowledge from service
        _knowledge = new List<KnowledgeItem>
        {
            new KnowledgeItem
            {
                Id = 1,
                Title = "React Documentation - Hooks & Context API",
                Category = "Frontend Development",
                UpdatedAt = DateTime.Now.AddDays(-3)
            },
            new KnowledgeItem
            {
                Id = 2,
                Title = "TypeScript Handbook - Advanced Types",
                Category = "Frontend Development",
                UpdatedAt = DateTime.Now.AddDays(-7)
            },
            new KnowledgeItem
            {
                Id = 3,
                Title = "REST API Authentication - OAuth 2.0 Guide",
                Category = "API Documentation",
                UpdatedAt = DateTime.Now.AddDays(-5)
            },
            new KnowledgeItem
            {
                Id = 4,
                Title = "Design System Specification v2.0",
                Category = "Design Specs",
                UpdatedAt = DateTime.Now.AddDays(-15)
            }
        };

        _collections = new List<CollectionItem>
        {
            new CollectionItem { Id = 1, Name = "API Documentation", ItemCount = 15 },
            new CollectionItem { Id = 2, Name = "Meeting Notes", ItemCount = 8 },
            new CollectionItem { Id = 3, Name = "Design Specs", ItemCount = 12 },
            new CollectionItem { Id = 4, Name = "Frontend Development", ItemCount = 23 }
        };
    }

    private void ToggleKnowledgeSelection(KnowledgeItem item)
    {
        item.IsSelected = !item.IsSelected;
        StateHasChanged();
    }

    private void ToggleCollectionSelection(CollectionItem collection)
    {
        collection.IsSelected = !collection.IsSelected;
        StateHasChanged();
    }

    private bool IsKnowledgeSelected(KnowledgeItem item) => item.IsSelected;
    private bool IsCollectionSelected(CollectionItem collection) => collection.IsSelected;

    private bool HasSelection() =>
        _knowledge.Any(k => k.IsSelected) || _collections.Any(c => c.IsSelected);

    private int GetSelectionCount() =>
        _knowledge.Count(k => k.IsSelected) + _collections.Count(c => c.IsSelected);

    void Submit()
    {
        var result = new
        {
            Knowledge = _knowledge.Where(k => k.IsSelected).ToList(),
            Collections = _collections.Where(c => c.IsSelected).ToList()
        };
        MudDialog.Close(DialogResult.Ok(result));
    }

    void Cancel() => MudDialog.Cancel();

    public class KnowledgeItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public DateTime UpdatedAt { get; set; }
        public bool IsSelected { get; set; }
    }

    public class CollectionItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public int ItemCount { get; set; }
        public bool IsSelected { get; set; }
    }
}
