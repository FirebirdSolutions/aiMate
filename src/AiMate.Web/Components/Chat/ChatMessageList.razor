@using AiMate.Core.Entities
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inject IJSRuntime JSRuntime

<div class="flex-1 overflow-y-auto px-6 py-6 scroll-smooth" @ref="scrollContainer">
    <div class="max-w-5xl mx-auto">
        @if (Messages == null || !Messages.Any())
        {
            @* Empty State *@
            <div class="flex flex-col items-center justify-center h-full min-h-[60vh] text-center">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-500/20 to-blue-500/20 flex items-center justify-center mb-6">
                    <svg class="w-10 h-10 text-purple-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 0 1-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-200 mb-2">Start a new conversation</h3>
                <p class="text-gray-400 text-sm max-w-md">
                    Ask me anything! I can help with coding, writing, analysis, and much more.
                </p>

                @if (ExamplePrompts?.Any() == true)
                {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-8 w-full max-w-2xl">
                        @foreach (var prompt in ExamplePrompts.Take(4))
                        {
                            <button @onclick="() => OnExampleClick.InvokeAsync(prompt)"
                                    class="p-4 bg-[#1A1A1A] hover:bg-[#242424] border border-[#2A2A2A] hover:border-purple-500/50 rounded-xl text-left transition-all group">
                                <div class="flex items-start gap-3">
                                    <svg class="w-5 h-5 text-purple-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z"/>
                                    </svg>
                                    <span class="text-sm text-gray-300 group-hover:text-white transition-colors">@prompt</span>
                                </div>
                            </button>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            @* Message List *@
            @if (UseVirtualization && Messages.Count > VirtualizationThreshold)
            {
                @* Virtualized List for Large Histories *@
                <Virtualize Items="@Messages" Context="message" OverscanCount="5">
                    <EnhancedChatMessage Message="message"
                                        UserName="@UserName"
                                        OnEdit="@((content) => HandleEditMessage(message.Id, content))"
                                        OnRegenerate="@(() => HandleRegenerateMessage(message.Id))"
                                        OnDelete="@(() => HandleDeleteMessage(message.Id))"
                                        OnShare="@(() => HandleShareMessage(message.Id))" />
                </Virtualize>
            }
            else
            {
                @* Regular List *@
                @foreach (var message in Messages)
                {
                    <EnhancedChatMessage @key="message.Id"
                                        Message="message"
                                        UserName="@UserName"
                                        OnEdit="@((content) => HandleEditMessage(message.Id, content))"
                                        OnRegenerate="@(() => HandleRegenerateMessage(message.Id))"
                                        OnDelete="@(() => HandleDeleteMessage(message.Id))"
                                        OnShare="@(() => HandleShareMessage(message.Id))" />
                }
            }

            @* Loading Indicator *@
            @if (IsLoading)
            {
                <div class="flex gap-4 mb-6">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center shadow-lg animate-pulse">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-3 text-gray-400">
                            <div class="flex gap-1.5">
                                <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                                <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                                <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                            </div>
                            <span class="text-sm font-medium">@LoadingText</span>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    @* Scroll to Bottom Button *@
    @if (showScrollButton)
    {
        <button @onclick="ScrollToBottom"
                class="fixed bottom-24 right-8 p-3 bg-purple-600 hover:bg-purple-700 text-white rounded-full shadow-lg hover:shadow-purple-500/50 transition-all transform hover:scale-110 z-10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        </button>
    }
</div>

@code {
    [Parameter] public List<Message>? Messages { get; set; }
    [Parameter] public string? UserName { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public string LoadingText { get; set; } = "Thinking...";
    [Parameter] public List<string>? ExamplePrompts { get; set; }
    [Parameter] public EventCallback<string> OnExampleClick { get; set; }
    [Parameter] public EventCallback<(Guid messageId, string content)> OnEditMessage { get; set; }
    [Parameter] public EventCallback<Guid> OnRegenerateMessage { get; set; }
    [Parameter] public EventCallback<Guid> OnDeleteMessage { get; set; }
    [Parameter] public EventCallback<Guid> OnShareMessage { get; set; }
    [Parameter] public bool UseVirtualization { get; set; } = true;
    [Parameter] public int VirtualizationThreshold { get; set; } = 50;

    private ElementReference scrollContainer;
    private bool showScrollButton = false;
    private bool autoScroll = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (autoScroll)
        {
            await ScrollToBottom();
        }
    }

    private async Task HandleEditMessage(Guid messageId, string content)
    {
        if (OnEditMessage.HasDelegate)
        {
            await OnEditMessage.InvokeAsync((messageId, content));
        }
    }

    private async Task HandleRegenerateMessage(Guid messageId)
    {
        if (OnRegenerateMessage.HasDelegate)
        {
            await OnRegenerateMessage.InvokeAsync(messageId);
        }
    }

    private async Task HandleDeleteMessage(Guid messageId)
    {
        if (OnDeleteMessage.HasDelegate)
        {
            await OnDeleteMessage.InvokeAsync(messageId);
        }
    }

    private async Task HandleShareMessage(Guid messageId)
    {
        if (OnShareMessage.HasDelegate)
        {
            await OnShareMessage.InvokeAsync(messageId);
        }
    }

    public async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", scrollContainer);
        }
        catch
        {
            // Ignore JS errors
        }
    }

    private async Task CheckScrollPosition()
    {
        try
        {
            var isAtBottom = await JSRuntime.InvokeAsync<bool>("isScrolledToBottom", scrollContainer);
            showScrollButton = !isAtBottom;
            autoScroll = isAtBottom;
            StateHasChanged();
        }
        catch
        {
            // Ignore JS errors
        }
    }
}
