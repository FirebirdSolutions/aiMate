@using AiMate.Core.Models
@inject IJSRuntime JSRuntime

<div class="flex gap-4 @(IsUser ? "flex-row-reverse" : "flex-row") mb-6 group">
    @* Avatar *@
    @if (!IsUser)
    {
        <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z"/>
                </svg>
            </div>
        </div>
    }
    else
    {
        <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-sm font-medium text-white">
                U
            </div>
        </div>
    }

    @* Message Content *@
    <div class="flex-1 max-w-3xl">
        @if (isEditing)
        {
            @* Edit Mode *@
            <div class="space-y-2">
                <textarea @bind="editedContent"
                          class="w-full p-3 bg-[#242424] border border-[#2A2A2A] rounded-lg text-white resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"
                          rows="4"></textarea>
                <div class="flex gap-2">
                    <button @onclick="HandleSaveEdit"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-all">
                        Save
                    </button>
                    <button @onclick="HandleCancelEdit"
                            class="px-4 py-2 bg-[#242424] hover:bg-[#2A2A2A] text-gray-300 rounded-lg text-sm font-medium transition-all">
                        Cancel
                    </button>
                </div>
            </div>
        }
        else
        {
            @* Display Mode *@
            <div class="@(IsUser ? "bg-[#242424]" : "bg-transparent") rounded-lg p-4">
                @if (IsUser)
                {
                    <div class="text-white whitespace-pre-wrap">@Content</div>
                }
                else
                {
                    @* AI Message with Markdown *@
                    <div class="prose prose-invert max-w-none">
                        @((MarkupString)RenderMarkdown(Content))
                    </div>
                }
            </div>

            @* Structured Content (if any) *@
            @if (StructuredContent != null)
            {
                <div class="mt-4">
                    <StructuredPanel Data="StructuredContent" />
                </div>
            }

            @* Message Actions *@
            <div class="flex items-center gap-1 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                @if (!IsUser)
                {
                    <button @onclick="HandleCopy"
                            class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                            title="Copy">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                    </button>

                    <button @onclick="HandleReadAloud"
                            class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                            title="Read Aloud">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                    </button>

                    <button @onclick="HandleLike"
                            class="p-2 @(liked ? "text-green-400" : "text-gray-400") hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                            title="Like">
                        <svg class="w-4 h-4" fill="@(liked ? "currentColor" : "none")" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                        </svg>
                    </button>

                    <button @onclick="HandleDislike"
                            class="p-2 @(disliked ? "text-red-400" : "text-gray-400") hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                            title="Dislike">
                        <svg class="w-4 h-4" fill="@(disliked ? "currentColor" : "none")" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>
                        </svg>
                    </button>

                    @if (OnRegenerate.HasDelegate)
                    {
                        <button @onclick="OnRegenerate"
                                class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Regenerate">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                                <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                                <path d="M16 21h5v-5"/>
                            </svg>
                        </button>
                    }
                }
                else
                {
                    <button @onclick="HandleStartEdit"
                            class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                            title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                        </svg>
                    </button>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public MessageRole Role { get; set; }
    [Parameter] public string Content { get; set; } = string.Empty;
    [Parameter] public DateTime Timestamp { get; set; }
    [Parameter] public StructuredData? StructuredContent { get; set; }
    [Parameter] public EventCallback<string> OnEdit { get; set; }
    [Parameter] public EventCallback OnRegenerate { get; set; }

    private bool IsUser => Role == MessageRole.User;
    private bool isEditing = false;
    private string editedContent = string.Empty;
    private bool liked = false;
    private bool disliked = false;

    private async Task HandleCopy()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", Content);
        // TODO: Show toast notification
    }

    private async Task HandleReadAloud()
    {
        // TODO: Implement text-to-speech
        await Task.CompletedTask;
    }

    private void HandleLike()
    {
        liked = !liked;
        if (liked) disliked = false;
    }

    private void HandleDislike()
    {
        disliked = !disliked;
        if (disliked) liked = false;
    }

    private void HandleStartEdit()
    {
        editedContent = Content;
        isEditing = true;
    }

    private async Task HandleSaveEdit()
    {
        if (!string.IsNullOrWhiteSpace(editedContent))
        {
            await OnEdit.InvokeAsync(editedContent);
            isEditing = false;
        }
    }

    private void HandleCancelEdit()
    {
        isEditing = false;
        editedContent = string.Empty;
    }

    private string RenderMarkdown(string markdown)
    {
        // TODO: Implement proper Markdown rendering with Markdig
        // For now, basic HTML escaping and line breaks
        return markdown
            .Replace("&", "&amp;")
            .Replace("<", "&lt;")
            .Replace(">", "&gt;")
            .Replace("\n", "<br/>");
    }
}
