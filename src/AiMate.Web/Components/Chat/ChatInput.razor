@inject IJSRuntime JSRuntime

<div class="border-t border-[#2A2A2A] bg-[#1A1A1A] p-4">
    <div class="max-w-4xl mx-auto">
        @* Attachment Context Chips *@
        @if (attachments.Any())
        {
            <div class="flex flex-wrap gap-2 mb-3">
                @foreach (var attachment in attachments)
                {
                    <div class="flex items-center gap-2 px-3 py-2 bg-[#242424] border border-[#2A2A2A] rounded-lg text-sm">
                        <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                        </svg>
                        <span class="text-gray-300">@attachment.Name</span>
                        <button @onclick="@(() => RemoveAttachment(attachment))"
                                class="text-gray-400 hover:text-white transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                }
            </div>
        }

        @* Input Area *@
        <div class="flex items-end gap-2">
            @* Attach Button *@
            <div class="relative">
                <button @onclick="ToggleAttachMenu"
                        class="p-3 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                        title="Attach">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </button>

                @* Attach Menu *@
                @if (attachMenuOpen)
                {
                    <div class="absolute bottom-full left-0 mb-2 w-56 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-2 z-50">
                        <button @onclick="HandleAttachFile"
                                class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                                <polyline points="13 2 13 9 20 9"/>
                            </svg>
                            Upload File
                        </button>
                        <button @onclick="HandleAttachImage"
                                class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            Upload Image
                        </button>
                        <button @onclick="HandleAttachKnowledge"
                                class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                            </svg>
                            From Knowledge
                        </button>
                    </div>
                }
            </div>

            @* Text Input *@
            <div class="flex-1 relative">
                <textarea @bind="message"
                          @bind:event="oninput"
                          @onkeydown="HandleKeyDown"
                          @ref="textareaRef"
                          placeholder="Send a Message"
                          class="w-full px-4 py-3 pr-12 bg-[#242424] border border-[#2A2A2A] rounded-lg text-white placeholder-gray-500 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 max-h-32 overflow-y-auto"
                          rows="1"></textarea>

                @* Character Count (optional) *@
                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="absolute bottom-2 right-2 text-xs text-gray-500">
                        @message.Length
                    </div>
                }
            </div>

            @* Send Button *@
            <button @onclick="HandleSend"
                    disabled="@(string.IsNullOrWhiteSpace(message))"
                    class="p-3 @(string.IsNullOrWhiteSpace(message) ? "bg-gray-700 text-gray-500" : "bg-purple-600 hover:bg-purple-700 text-white") rounded-lg transition-all disabled:cursor-not-allowed"
                    title="Send">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M22 2L11 13"/>
                    <path d="M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>

        @* Helper Text *@
        <div class="mt-2 text-xs text-gray-500 text-center">
            Press Enter to send, Shift+Enter for new line
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback<string> OnSend { get; set; }
    [Parameter] public EventCallback<List<Attachment>> OnAttachmentsChanged { get; set; }

    private string message = string.Empty;
    private bool attachMenuOpen = false;
    private List<Attachment> attachments = new();
    private ElementReference textareaRef;

    private void ToggleAttachMenu()
    {
        attachMenuOpen = !attachMenuOpen;
    }

    private async Task HandleSend()
    {
        if (!string.IsNullOrWhiteSpace(message))
        {
            await OnSend.InvokeAsync(message);
            message = string.Empty;
            attachments.Clear();
            await OnAttachmentsChanged.InvokeAsync(attachments);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            e.preventDefault();
            await HandleSend();
        }
    }

    private async Task HandleAttachFile()
    {
        // TODO: Implement file upload
        attachMenuOpen = false;
        await Task.CompletedTask;
    }

    private async Task HandleAttachImage()
    {
        // TODO: Implement image upload
        attachMenuOpen = false;
        await Task.CompletedTask;
    }

    private async Task HandleAttachKnowledge()
    {
        // TODO: Open knowledge picker dialog
        attachMenuOpen = false;
        await Task.CompletedTask;
    }

    private async Task RemoveAttachment(Attachment attachment)
    {
        attachments.Remove(attachment);
        await OnAttachmentsChanged.InvokeAsync(attachments);
    }

    public class Attachment
    {
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string Url { get; set; } = string.Empty;
    }
}
