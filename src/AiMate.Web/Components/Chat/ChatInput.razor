@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject HttpClient HttpClient

@* Hidden file input *@
<input type="file" id="fileInput" multiple style="display: none;" />

<div class="border-t border-[#2A2A2A] bg-[#1A1A1A] p-4">
    <div class="max-w-4xl mx-auto">
        @* Attachment Context Chips - Color Coded *@
        @if (attachments.Any())
        {
            <div class="flex flex-wrap gap-2 mb-3">
                @foreach (var attachment in attachments)
                {
                    var chipColors = GetChipColors(attachment.Type);
                    <div class="flex items-center gap-2 px-3 py-1.5 @chipColors.Background border @chipColors.Border rounded-md text-sm">
                        <span class="@chipColors.Text font-medium">@attachment.Name</span>
                        <button @onclick="@(() => RemoveAttachment(attachment))"
                                class="@chipColors.CloseButton hover:text-white transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                }
            </div>
        }

        @* Input Area *@
        <div class="flex items-end gap-2">
            @* Attach Button with Counter Badge *@
            <div class="relative">
                <button @onclick="ToggleAttachMenu"
                        class="relative p-3 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                        title="Attach content">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>

                    @* Counter Badge *@
                    @if (attachments.Count > 0)
                    {
                        <span class="absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-purple-600 rounded-full border-2 border-[#1A1A1A]">
                            @attachments.Count
                        </span>
                    }
                </button>

                @* Attach Menu - Enhanced *@
                @if (attachMenuOpen)
                {
                    <div class="absolute bottom-full left-0 mb-2 w-64 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-2 z-50">
                        @* Attach Files *@
                        <button @onclick="HandleAttachFile"
                                class="flex items-center justify-between w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <div class="flex items-center gap-3">
                                <svg class="w-[18px] h-[18px] text-purple-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                                    <polyline points="13 2 13 9 20 9"/>
                                </svg>
                                <span>Attach Files</span>
                            </div>
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </button>

                        <div class="h-px bg-[#2A2A2A] my-1"></div>

                        @* Capture *@
                        <button @onclick="HandleCapture"
                                class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <svg class="w-[18px] h-[18px] text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                            <span>Capture</span>
                        </button>

                        @* Attach Webpage *@
                        <button @onclick="HandleAttachWebpage"
                                class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <svg class="w-[18px] h-[18px] text-cyan-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="2" y1="12" x2="22" y2="12"/>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                            </svg>
                            <span>Attach Webpage</span>
                        </button>

                        @* Attach Notes *@
                        <button @onclick="HandleAttachNotes"
                                class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <svg class="w-[18px] h-[18px] text-yellow-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10 9 9 9 8 9"/>
                            </svg>
                            <span>Attach Notes</span>
                        </button>

                        @* Attach Knowledge *@
                        <button @onclick="HandleAttachKnowledge"
                                class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <svg class="w-[18px] h-[18px] text-green-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                            </svg>
                            <span>Attach Knowledge</span>
                        </button>

                        <div class="h-px bg-[#2A2A2A] my-1"></div>

                        @* Reference Chat *@
                        <button @onclick="HandleReferenceChat"
                                class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                            <svg class="w-[18px] h-[18px] text-orange-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <span>Reference Chat</span>
                        </button>
                    </div>
                }
            </div>

            @* Text Input *@
            <div class="flex-1 relative">
                <textarea @bind="message"
                          @bind:event="oninput"
                          @onkeydown="HandleKeyDown"
                          @ref="textareaRef"
                          placeholder="Send a Message"
                          class="w-full px-4 py-3 pr-12 bg-[#242424] border border-[#2A2A2A] rounded-lg text-white placeholder-gray-500 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 max-h-32 overflow-y-auto"
                          rows="1"></textarea>

                @* Character Count (optional) *@
                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="absolute bottom-2 right-2 text-xs text-gray-500">
                        @message.Length
                    </div>
                }
            </div>

            @* Send Button *@
            <button @onclick="HandleSend"
                    disabled="@(string.IsNullOrWhiteSpace(message))"
                    class="p-3 @(string.IsNullOrWhiteSpace(message) ? "bg-gray-700 text-gray-500" : "bg-purple-600 hover:bg-purple-700 text-white") rounded-lg transition-all disabled:cursor-not-allowed"
                    title="Send">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M22 2L11 13"/>
                    <path d="M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>

        @* Helper Text *@
        <div class="mt-2 text-xs text-gray-500 text-center">
            Press Enter to send, Shift+Enter for new line
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback<string> OnSend { get; set; }
    [Parameter] public EventCallback<List<Attachment>> OnAttachmentsChanged { get; set; }

    private string message = string.Empty;
    private bool attachMenuOpen = false;
    private List<Attachment> attachments = new();
    private ElementReference textareaRef;

    private void ToggleAttachMenu()
    {
        attachMenuOpen = !attachMenuOpen;
    }

    private async Task HandleSend()
    {
        if (!string.IsNullOrWhiteSpace(message))
        {
            await OnSend.InvokeAsync(message);
            message = string.Empty;
            attachments.Clear();
            await OnAttachmentsChanged.InvokeAsync(attachments);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            e.preventDefault();
            await HandleSend();
        }
    }

    private async Task HandleAttachFile()
    {
        attachMenuOpen = false;

        try
        {
            // Call JS to trigger file input
            var files = await JSRuntime.InvokeAsync<FileData[]>("attachmentHelpers.handleFileSelection",
                await JSRuntime.InvokeAsync<object>("document.getElementById", "fileInput"));

            if (files != null && files.Length > 0)
            {
                foreach (var file in files)
                {
                    attachments.Add(new Attachment
                    {
                        Name = file.Name,
                        Type = "file",
                        Url = file.Data
                    });
                }

                await OnAttachmentsChanged.InvokeAsync(attachments);
                Snackbar.Add($"{files.Length} file(s) attached", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to attach files: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleCapture()
    {
        attachMenuOpen = false;

        try
        {
            // Show choice: Screenshot or Photo
            var options = new DialogOptions { MaxWidth = MaxWidth.Small };
            var parameters = new DialogParameters
            {
                ["Message"] = "Choose capture type",
                ["Buttons"] = new[] { "Screenshot", "Photo", "Cancel" }
            };

            // For now, try screenshot
            var screenshot = await JSRuntime.InvokeAsync<FileData>("attachmentHelpers.captureScreenshot");

            if (screenshot != null)
            {
                attachments.Add(new Attachment
                {
                    Name = screenshot.Name,
                    Type = "file",
                    Url = screenshot.Data
                });

                await OnAttachmentsChanged.InvokeAsync(attachments);
                Snackbar.Add("Screenshot captured", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Capture failed: {ex.Message}", Severity.Warning);
        }
    }

    private async Task HandleAttachWebpage()
    {
        attachMenuOpen = false;

        var parameters = new DialogParameters
        {
            ["Title"] = "Attach Webpage",
            ["Label"] = "Enter URL",
            ["Placeholder"] = "https://example.com"
        };

        var dialog = await DialogService.ShowAsync<TextInputDialog>("Attach Webpage", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string url)
        {
            try
            {
                Snackbar.Add("Fetching webpage...", Severity.Info);

                var response = await HttpClient.PostAsJsonAsync("/api/v1/attachments/fetch-webpage", new { Url = url });

                if (response.IsSuccessStatusCode)
                {
                    var webpageData = await response.Content.ReadFromJsonAsync<WebpageData>();

                    if (webpageData != null)
                    {
                        attachments.Add(new Attachment
                        {
                            Name = webpageData.Title,
                            Type = "webpage",
                            Url = webpageData.Url
                        });

                        await OnAttachmentsChanged.InvokeAsync(attachments);
                        Snackbar.Add("Webpage attached", Severity.Success);
                    }
                }
                else
                {
                    Snackbar.Add("Failed to fetch webpage", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error fetching webpage: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task HandleAttachNotes()
    {
        attachMenuOpen = false;

        var dialog = await DialogService.ShowAsync<NotesPickerDialog>("Select Notes");
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            var selectedNotes = result.Data as List<NotesPickerDialog.NoteItem>;

            if (selectedNotes != null && selectedNotes.Any())
            {
                foreach (var note in selectedNotes)
                {
                    attachments.Add(new Attachment
                    {
                        Name = note.Title,
                        Type = "note",
                        Url = $"/notes/{note.Id}"
                    });
                }

                await OnAttachmentsChanged.InvokeAsync(attachments);
                Snackbar.Add($"{selectedNotes.Count} note(s) attached", Severity.Success);
            }
        }
    }

    private async Task HandleAttachKnowledge()
    {
        attachMenuOpen = false;

        var dialog = await DialogService.ShowAsync<KnowledgePickerDialog>("Select Knowledge");
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            dynamic selectedItems = result.Data;
            var knowledge = selectedItems.Knowledge as List<KnowledgePickerDialog.KnowledgeItem>;
            var collections = selectedItems.Collections as List<KnowledgePickerDialog.CollectionItem>;

            int count = 0;

            if (knowledge != null)
            {
                foreach (var item in knowledge)
                {
                    attachments.Add(new Attachment
                    {
                        Name = item.Title,
                        Type = "knowledge",
                        Url = $"/knowledge/{item.Id}"
                    });
                    count++;
                }
            }

            if (collections != null)
            {
                foreach (var collection in collections)
                {
                    attachments.Add(new Attachment
                    {
                        Name = collection.Name,
                        Type = "knowledge",
                        Url = $"/knowledge/collections/{collection.Id}"
                    });
                    count++;
                }
            }

            if (count > 0)
            {
                await OnAttachmentsChanged.InvokeAsync(attachments);
                Snackbar.Add($"{count} knowledge item(s) attached", Severity.Success);
            }
        }
    }

    private async Task HandleReferenceChat()
    {
        attachMenuOpen = false;

        var dialog = await DialogService.ShowAsync<ChatReferencePickerDialog>("Reference Chat");
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            var selectedChats = result.Data as List<ChatReferencePickerDialog.ConversationItem>;

            if (selectedChats != null && selectedChats.Any())
            {
                foreach (var chat in selectedChats)
                {
                    attachments.Add(new Attachment
                    {
                        Name = chat.Title,
                        Type = "chat",
                        Url = $"/chat/{chat.Id}"
                    });
                }

                await OnAttachmentsChanged.InvokeAsync(attachments);
                Snackbar.Add($"{selectedChats.Count} conversation(s) referenced", Severity.Success);
            }
        }
    }

    private async Task RemoveAttachment(Attachment attachment)
    {
        attachments.Remove(attachment);
        await OnAttachmentsChanged.InvokeAsync(attachments);
    }

    private ChipColors GetChipColors(string type)
    {
        return type.ToLower() switch
        {
            "file" => new ChipColors
            {
                Background = "bg-purple-500/10",
                Border = "border-purple-500/30",
                Text = "text-purple-300",
                CloseButton = "text-purple-400"
            },
            "note" => new ChipColors
            {
                Background = "bg-yellow-500/10",
                Border = "border-yellow-500/30",
                Text = "text-yellow-300",
                CloseButton = "text-yellow-400"
            },
            "knowledge" => new ChipColors
            {
                Background = "bg-orange-500/10",
                Border = "border-orange-500/30",
                Text = "text-orange-300",
                CloseButton = "text-orange-400"
            },
            "webpage" => new ChipColors
            {
                Background = "bg-cyan-500/10",
                Border = "border-cyan-500/30",
                Text = "text-cyan-300",
                CloseButton = "text-cyan-400"
            },
            "chat" => new ChipColors
            {
                Background = "bg-blue-500/10",
                Border = "border-blue-500/30",
                Text = "text-blue-300",
                CloseButton = "text-blue-400"
            },
            _ => new ChipColors
            {
                Background = "bg-gray-500/10",
                Border = "border-gray-500/30",
                Text = "text-gray-300",
                CloseButton = "text-gray-400"
            }
        };
    }

    public class Attachment
    {
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string Url { get; set; } = string.Empty;
    }

    public class ChipColors
    {
        public string Background { get; set; } = string.Empty;
        public string Border { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
        public string CloseButton { get; set; } = string.Empty;
    }

    public class FileData
    {
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public long Size { get; set; }
        public string Data { get; set; } = string.Empty;
    }

    public class WebpageData
    {
        public string Url { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }
}
