@using AiMate.Web.Components.Dialogs
@using AiMate.Core.Services
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IFileUploadService FileUploadService
@inject IJSRuntime JS

<MudMenu Icon="@Icons.Material.Filled.AttachFile"
         Variant="Variant.Filled"
         Color="Color.Primary"
         AnchorOrigin="Origin.TopCenter"
         TransformOrigin="Origin.BottomCenter"
         Dense="@Dense"
         Size="@Size"
         @ref="_menu">
    @* Recent Files Section *@
    @if (_recentFiles.Any())
    {
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="px-4 pt-2 pb-1">
            Recent Files
        </MudText>
        @foreach (var file in _recentFiles.Take(5))
        {
            <MudMenuItem Icon="@GetFileIcon(file.Type)"
                         IconColor="Color.Primary"
                         OnClick="@(() => AttachRecentFile(file))">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2" Style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            @file.Name
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @FormatFileSize(file.Size) • @file.UploadedAt.ToString("MMM dd")
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudMenuItem>
        }
        <MudDivider Class="my-1" />
    }

    @* Files *@
    <MudMenuItem Icon="@Icons.Material.Filled.InsertDriveFile"
                 IconColor="Color.Primary"
                 OnClick="@HandleAttachFiles">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">Files</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Upload documents, images, etc.</MudText>
            </MudStack>
            <MudText Typo="Typo.caption" Color="Color.Secondary">⌘F</MudText>
        </MudStack>
    </MudMenuItem>

    <MudDivider Class="my-1" />

    @* Capture Screenshot *@
    <MudMenuItem Icon="@Icons.Material.Filled.Screenshot"
                 IconColor="Color.Info"
                 OnClick="@HandleCaptureScreenshot">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">Capture</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Take a screenshot</MudText>
            </MudStack>
            <MudText Typo="Typo.caption" Color="Color.Secondary">⌘S</MudText>
        </MudStack>
    </MudMenuItem>

    @* Webcam *@
    <MudMenuItem Icon="@Icons.Material.Filled.PhotoCamera"
                 IconColor="Color.Warning"
                 OnClick="@HandleCapturePhoto">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">Camera</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Capture from webcam</MudText>
            </MudStack>
        </MudStack>
    </MudMenuItem>

    <MudDivider Class="my-1" />

    @* Webpage *@
    <MudMenuItem Icon="@Icons.Material.Filled.Language"
                 IconColor="Color.Secondary"
                 OnClick="@HandleAttachWebpage">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">Webpage</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Fetch and analyze a URL</MudText>
            </MudStack>
            <MudText Typo="Typo.caption" Color="Color.Secondary">⌘W</MudText>
        </MudStack>
    </MudMenuItem>

    @* Notes *@
    <MudMenuItem Icon="@Icons.Material.Filled.Note"
                 IconColor="Color.Success"
                 OnClick="@HandleAttachNote">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">Notes</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Attach a saved note</MudText>
            </MudStack>
            <MudText Typo="Typo.caption" Color="Color.Secondary">⌘N</MudText>
        </MudStack>
    </MudMenuItem>

    @* Knowledge Base *@
    <MudMenuItem Icon="@Icons.Material.Filled.LibraryBooks"
                 IconColor="Color.Tertiary"
                 OnClick="@HandleAttachKnowledge">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">Knowledge</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Attach from knowledge base</MudText>
            </MudStack>
            <MudText Typo="Typo.caption" Color="Color.Secondary">⌘K</MudText>
        </MudStack>
    </MudMenuItem>

    <MudDivider Class="my-1" />

    @* Reference Chat *@
    <MudMenuItem Icon="@Icons.Material.Filled.Chat"
                 IconColor="Color.Info"
                 OnClick="@HandleReferenceChat">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">Reference Chat</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Link to another conversation</MudText>
            </MudStack>
            <MudText Typo="Typo.caption" Color="Color.Secondary">⌘R</MudText>
        </MudStack>
    </MudMenuItem>

    @* Clipboard *@
    <MudMenuItem Icon="@Icons.Material.Filled.ContentPaste"
                 IconColor="Color.Default"
                 OnClick="@HandlePasteFromClipboard">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.body2">Clipboard</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Paste from clipboard</MudText>
            </MudStack>
            <MudText Typo="Typo.caption" Color="Color.Secondary">⌘V</MudText>
        </MudStack>
    </MudMenuItem>

    @if (ShowAdvancedOptions)
    {
        <MudDivider Class="my-1" />

        @* Code Snippet *@
        <MudMenuItem Icon="@Icons.Material.Filled.Code"
                     IconColor="Color.Dark"
                     OnClick="@HandleAttachCodeSnippet">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.body2">Code Snippet</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Attach formatted code</MudText>
                </MudStack>
            </MudStack>
        </MudMenuItem>

        @* Audio Recording *@
        <MudMenuItem Icon="@Icons.Material.Filled.Mic"
                     IconColor="Color.Error"
                     OnClick="@HandleRecordAudio">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="min-width: 200px;">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.body2">Audio Recording</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Record voice message</MudText>
                </MudStack>
            </MudStack>
        </MudMenuItem>
    }
</MudMenu>

@code {
    [Parameter] public EventCallback<List<AttachedFile>> OnFilesAttached { get; set; }
    [Parameter] public Guid WorkspaceId { get; set; }
    [Parameter] public bool ShowAdvancedOptions { get; set; } = false;
    [Parameter] public bool Dense { get; set; } = false;
    [Parameter] public Size Size { get; set; } = Size.Medium;

    private MudMenu? _menu;
    private List<RecentFile> _recentFiles = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentFiles();
    }

    private async Task LoadRecentFiles()
    {
        try
        {
            // Get workspace files and take the 10 most recent
            var files = await FileUploadService.GetWorkspaceFilesAsync(WorkspaceId);
            _recentFiles = files
                .OrderByDescending(f => f.UploadedAt)
                .Take(10)
                .Select(f => new RecentFile
                {
                    Id = f.Id,
                    Name = f.FileName,
                    Size = f.FileSize,
                    Type = DetermineFileType(f.ContentType),
                    UploadedAt = f.UploadedAt
                })
                .ToList();
        }
        catch
        {
            // Silently fail - recent files is a nice-to-have feature
            _recentFiles = new();
        }
    }

    private async Task AttachRecentFile(RecentFile file)
    {
        var attachedFiles = new List<AttachedFile>
        {
            new AttachedFile
            {
                Name = file.Name,
                Type = file.Type,
                Size = file.Size,
                Url = $"/api/v1/files/{file.Id}/download"
            }
        };

        await OnFilesAttached.InvokeAsync(attachedFiles);
        Snackbar.Add($"Attached {file.Name}", Severity.Success);
        _menu?.CloseMenuAsync();
    }

    private async Task HandleAttachFiles()
    {
        // Trigger file input dialog using JS interop
        try
        {
            var fileInput = await JS.InvokeAsync<IJSObjectReference>("eval", "document.createElement('input')");
            await JS.InvokeVoidAsync("eval", @"
                const input = arguments[0];
                input.type = 'file';
                input.multiple = true;
                input.accept = '.txt,.md,.pdf,.png,.jpg,.jpeg,.doc,.docx,.xlsx,.csv';
                input.click();
            ", fileInput);

            // Note: File handling would happen in the parent component
            Snackbar.Add("File selection dialog opened", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to open file dialog: {ex.Message}", Severity.Error);
        }
    }

    private string DetermineFileType(string contentType)
    {
        if (string.IsNullOrEmpty(contentType)) return "Other";
        if (contentType.StartsWith("image/")) return "Image";
        if (contentType.Contains("pdf") || contentType.Contains("document") || contentType.Contains("word")) return "Document";
        if (contentType.Contains("text/") || contentType.Contains("json") || contentType.Contains("xml")) return "Code";
        return "Other";
    }

    private string GetFileIcon(string type) => type switch
    {
        "Image" => Icons.Material.Filled.Image,
        "Document" => Icons.Material.Filled.Description,
        "Code" => Icons.Material.Filled.Code,
        _ => Icons.Material.Filled.InsertDriveFile
    };

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private class RecentFile
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public long Size { get; set; }
        public string Type { get; set; } = string.Empty;
        public DateTime UploadedAt { get; set; }
    }

    private async Task HandleCaptureScreenshot()
    {
        // IMPLEMENTATION NEEDED: Use browser Screen Capture API via JS interop
        // Example: await JSRuntime.InvokeAsync<string>("captureScreenshot");
        Snackbar.Add("Screenshot capture would start here", Severity.Info);
    }

    private async Task HandleCapturePhoto()
    {
        // IMPLEMENTATION NEEDED: Use MediaDevices.getUserMedia() via JS interop for webcam
        // Example: await JSRuntime.InvokeVoidAsync("capturePhoto");
        Snackbar.Add("Webcam capture would open here", Severity.Info);
    }

    private async Task HandleAttachWebpage()
    {
        // IMPLEMENTATION NEEDED: Show TextInputDialog and fetch webpage content
        var parameters = new DialogParameters
        {
            ["Title"] = "Attach Webpage",
            ["Label"] = "Enter URL",
            ["Placeholder"] = "https://example.com"
        };

        var dialog = await DialogService.ShowAsync<TextInputDialog>("Attach Webpage", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string url)
        {
            Snackbar.Add($"Fetching webpage: {url}", Severity.Info);
            // IMPLEMENTATION NEEDED: Call API endpoint to fetch and parse webpage
            // Example: await HttpClient.PostAsync("/api/v1/files/fetch-webpage", new { url });
        }
    }

    private async Task HandleAttachNote()
    {
        // IMPLEMENTATION NEEDED: Create NotesPickerDialog component and show it
        // Example: await DialogService.ShowAsync<NotesPickerDialog>("Select Notes");
        Snackbar.Add("Notes picker would open here", Severity.Info);
    }

    private async Task HandleAttachKnowledge()
    {
        // IMPLEMENTATION NEEDED: Create KnowledgePickerDialog component and show it
        // Example: await DialogService.ShowAsync<KnowledgePickerDialog>("Select Knowledge");
        Snackbar.Add("Knowledge base picker would open here", Severity.Info);
    }

    private async Task HandleReferenceChat()
    {
        // IMPLEMENTATION NEEDED: Create ConversationPickerDialog component and show it
        // Example: await DialogService.ShowAsync<ConversationPickerDialog>("Reference Chat");
        Snackbar.Add("Conversation picker would open here", Severity.Info);
    }

    private async Task HandlePasteFromClipboard()
    {
        // IMPLEMENTATION NEEDED: Use Clipboard API via JS interop
        // Example: var text = await JSRuntime.InvokeAsync<string>("navigator.clipboard.readText");
        Snackbar.Add("Reading from clipboard...", Severity.Info);
    }

    private async Task HandleAttachCodeSnippet()
    {
        // IMPLEMENTATION NEEDED: Create CodeSnippetDialog with language selector
        // Example: await DialogService.ShowAsync<CodeSnippetDialog>("Add Code Snippet");
        Snackbar.Add("Code snippet editor would open here", Severity.Info);
    }

    private Task HandleRecordAudio()
    {
        // IMPLEMENTATION NEEDED: Use MediaRecorder API via JS interop
        // Example: await JSRuntime.InvokeVoidAsync("startAudioRecording");
        Snackbar.Add("Audio recording would start here", Severity.Info);
        return Task.CompletedTask;
    }

    public class AttachedFile
    {
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public long Size { get; set; }
        public string Url { get; set; } = string.Empty;
        public byte[]? Data { get; set; }
    }
}
