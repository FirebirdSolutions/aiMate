@using Fluxor
@using AiMate.Web.Store.Admin
@using AiMate.Core.Enums
@using AiMate.Core.Services
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<AdminState> AdminState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IPermissionService PermissionService

<MudStack Spacing="3">
    <MudText Typo="Typo.h6">System Configuration</MudText>
    <MudDivider />

    @* General Settings *@
    <MudText Typo="Typo.subtitle1">General Settings</MudText>
    <MudPaper Class="pa-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudSwitch T="bool" Checked="@_enableAdminPanel"
                          Label="Enable Admin Panel"
                          Color="Color.Primary"
                          CheckedChanged="@((bool val) => { _enableAdminPanel = val; HandleToggleSetting("EnableAdminPanel", val); })" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Allow access to the admin panel for users with Admin tier
                </MudText>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSwitch T="bool" Checked="@_allowUserRegistration"
                          Label="Allow User Registration"
                          Color="Color.Primary"
                          CheckedChanged="@((bool val) => { _allowUserRegistration = val; HandleToggleSetting("AllowUserRegistration", val); })" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Enable new user sign-up on the platform
                </MudText>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSwitch T="bool" Checked="@_enableApiAccess"
                          Label="Enable API Access"
                          Color="Color.Primary"
                          CheckedChanged="@((bool val) => { _enableApiAccess = val; HandleToggleSetting("EnableApiAccess", val); })" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Allow external API access to aiMate services
                </MudText>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSwitch T="bool" Checked="@_debugMode"
                          Label="Debug Mode"
                          Color="Color.Warning"
                          CheckedChanged="@((bool val) => { _debugMode = val; HandleToggleSetting("DebugMode", val); })" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Enable verbose logging and debugging features
                </MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudDivider Class="my-4" />

    @* BYOK Configuration *@
    <MudText Typo="Typo.subtitle1">BYOK (Bring Your Own Key) Configuration</MudText>
    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
        Control which user tiers can bring their own API keys for LLM providers
    </MudText>
    <MudPaper Class="pa-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.CardMembership" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">Free Tier</MudText>
                        </MudStack>
                        <MudSwitch T="bool" Checked="@_byokFreeTier"
                                  Color="Color.Success"
                                  CheckedChanged="@((bool val) => HandleBYOKToggle(UserTier.Free, val))" />
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Max 3 connections • Ideal for individual users bringing own keys
                    </MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Key" Color="Color.Primary" />
                            <MudText Typo="Typo.subtitle2">BYOK Tier ($10/mo)</MudText>
                        </MudStack>
                        <MudSwitch T="bool" Checked="@_byokBYOKTier"
                                  Color="Color.Success"
                                  CheckedChanged="@((bool val) => HandleBYOKToggle(UserTier.BYOK, val))" />
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Max 10 connections • Enhanced limits for BYOK users
                    </MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Code" Color="Color.Info" />
                            <MudText Typo="Typo.subtitle2">Developer Tier ($30/mo)</MudText>
                        </MudStack>
                        <MudSwitch T="bool" Checked="@_byokDeveloperTier"
                                  Color="Color.Success"
                                  CheckedChanged="@((bool val) => HandleBYOKToggle(UserTier.Developer, val))" />
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Max 50 connections • Platform keys + BYOK + custom endpoints
                    </MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Color="Color.Error" />
                            <MudText Typo="Typo.subtitle2">Admin Tier</MudText>
                        </MudStack>
                        <MudSwitch T="bool" Checked="@_byokAdminTier"
                                  Color="Color.Success"
                                  CheckedChanged="@((bool val) => HandleBYOKToggle(UserTier.Admin, val))" />
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Unlimited connections • Full system access
                    </MudText>
                </MudStack>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-3" />

        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
            <strong>Freemium Model Strategy:</strong>
            <br />
            Free users with BYOK = Zero platform costs • Paid users get platform-provided API keys + enhanced features
        </MudAlert>
    </MudPaper>

    <MudDivider Class="my-4" />

    @* Database Management *@
    <MudText Typo="Typo.subtitle1">Database Management</MudText>
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">LocalStorage</MudText>
                    <MudProgressLinear T="double"
                                      Value="@((AdminState.Value.LocalStorageUsedMB / AdminState.Value.LocalStorageLimitMB) * 100)"
                                      Color="Color.Primary"
                                      Size="Size.Medium" />
                    <MudText Typo="Typo.body2">
                        @AdminState.Value.LocalStorageUsedMB.ToString("F1") MB / @AdminState.Value.LocalStorageLimitMB.ToString("F1") MB
                    </MudText>
                    <MudButton Variant="Variant.Outlined"
                              Color="Color.Error"
                              OnClick="@HandleClearLocalStorage">
                        Clear All Data
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">IndexedDB</MudText>
                    <MudProgressLinear T="double"
                                      Value="@((AdminState.Value.IndexedDBUsedMB / AdminState.Value.IndexedDBLimitMB) * 100)"
                                      Color="Color.Secondary"
                                      Size="Size.Medium" />
                    <MudText Typo="Typo.body2">
                        @AdminState.Value.IndexedDBUsedMB.ToString("F1") MB / @AdminState.Value.IndexedDBLimitMB.ToString("F1") MB
                    </MudText>
                    <MudButton Variant="Variant.Outlined"
                              Color="Color.Error"
                              OnClick="@HandleClearIndexedDB">
                        Clear Files
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-4" />

    @* System Logs *@
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.subtitle1">System Logs</MudText>
        <MudStack Row="true" Spacing="1">
            <MudButton Size="Size.Small" OnClick="@HandleRefreshLogs">Refresh</MudButton>
            <MudButton Size="Size.Small" OnClick="@HandleClearLogs">Clear</MudButton>
            <MudButton Size="Size.Small" OnClick="@HandleExportLogs">Export</MudButton>
        </MudStack>
    </MudStack>

    <MudPaper Class="pa-3" Elevation="0" Style="background: var(--mud-palette-surface); max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
        @foreach (var log in AdminState.Value.SystemLogs.Take(50))
        {
            <MudText Typo="Typo.caption" Color="@GetLogColor(log.Level)">
                [@log.Timestamp.ToString("HH:mm:ss")] [@log.Level] @log.Message
            </MudText>
        }
    </MudPaper>

    <MudDivider Class="my-4" />

    @* Maintenance *@
    <MudText Typo="Typo.subtitle1">Maintenance</MudText>
    <MudStack Row="true" Spacing="2">
        <MudButton Variant="Variant.Outlined"
                  StartIcon="@Icons.Material.Filled.Download"
                  OnClick="@(() => Dispatcher.Dispatch(new ExportSystemConfigAction()))">
            Export System Config
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                  StartIcon="@Icons.Material.Filled.Upload">
            Import Config
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                  StartIcon="@Icons.Material.Filled.Backup"
                  OnClick="@(() => Dispatcher.Dispatch(new CreateBackupAction()))">
            Create Backup
        </MudButton>
    </MudStack>

    <MudDivider Class="my-4" />

    @* Danger Zone *@
    <MudAlert Severity="Severity.Error">
        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle2">⚠️ Danger Zone</MudText>
            <MudText Typo="Typo.body2">
                Reset aiMate to factory defaults. This will delete ALL data, conversations, knowledge, and system configuration.
            </MudText>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Error"
                      StartIcon="@Icons.Material.Filled.DeleteForever"
                      OnClick="@HandleFactoryReset">
                Factory Reset System
            </MudButton>
        </MudStack>
    </MudAlert>
</MudStack>

@code {
    // General Settings
    private bool _enableAdminPanel = true;
    private bool _allowUserRegistration = false;
    private bool _enableApiAccess = true;
    private bool _debugMode = false;

    // BYOK Settings per tier
    private bool _byokFreeTier = true;
    private bool _byokBYOKTier = true;
    private bool _byokDeveloperTier = true;
    private bool _byokAdminTier = true;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Load current BYOK settings from PermissionService
        _byokFreeTier = PermissionService.IsBYOKEnabledForTier(UserTier.Free);
        _byokBYOKTier = PermissionService.IsBYOKEnabledForTier(UserTier.BYOK);
        _byokDeveloperTier = PermissionService.IsBYOKEnabledForTier(UserTier.Developer);
        _byokAdminTier = PermissionService.IsBYOKEnabledForTier(UserTier.Admin);

        // IMPLEMENTATION NEEDED: Create AdminState/SettingsState in Fluxor store
        // Then inject IState<AdminState> and load these values:
        // _enableAdminPanel = AdminState.Value.EnableAdminPanel;
        // _allowUserRegistration = AdminState.Value.AllowUserRegistration;
        // _enableApiAccess = AdminState.Value.EnableApiAccess;
        // _debugMode = AdminState.Value.DebugMode;
    }

    private void HandleToggleSetting(string setting, bool value)
    {
        switch (setting)
        {
            case "EnableAdminPanel":
                _enableAdminPanel = value;
                Snackbar.Add($"Admin Panel {(value ? "enabled" : "disabled")}", Severity.Success);
                // IMPLEMENTATION NEEDED: Create UpdateAdminSettingAction in AdminState store
                // Dispatcher.Dispatch(new UpdateAdminSettingAction("EnableAdminPanel", value));
                break;

            case "AllowUserRegistration":
                _allowUserRegistration = value;
                Snackbar.Add($"User Registration {(value ? "enabled" : "disabled")}", Severity.Success);
                // IMPLEMENTATION NEEDED: Dispatcher.Dispatch(new UpdateAdminSettingAction("AllowUserRegistration", value));
                break;

            case "EnableApiAccess":
                _enableApiAccess = value;
                Snackbar.Add($"API Access {(value ? "enabled" : "disabled")}", Severity.Success);
                // IMPLEMENTATION NEEDED: Dispatcher.Dispatch(new UpdateAdminSettingAction("EnableApiAccess", value));
                break;

            case "DebugMode":
                _debugMode = value;
                Snackbar.Add($"Debug Mode {(value ? "enabled" : "disabled")}", value ? Severity.Warning : Severity.Success);
                // IMPLEMENTATION NEEDED: Dispatcher.Dispatch(new UpdateAdminSettingAction("DebugMode", value));
                break;
        }
    }

    private void HandleBYOKToggle(UserTier tier, bool enabled)
    {
        // Update the PermissionService
        PermissionService.SetBYOKEnabledForTier(tier, enabled);

        // Update local state
        switch (tier)
        {
            case UserTier.Free:
                _byokFreeTier = enabled;
                break;
            case UserTier.BYOK:
                _byokBYOKTier = enabled;
                break;
            case UserTier.Developer:
                _byokDeveloperTier = enabled;
                break;
            case UserTier.Admin:
                _byokAdminTier = enabled;
                break;
        }

        Snackbar.Add($"BYOK {(enabled ? "enabled" : "disabled")} for {tier} tier", Severity.Success);

        // IMPLEMENTATION NEEDED: Persist to database via AdminState store
        // Example: Dispatcher.Dispatch(new UpdateBYOKSettingAction(tier, enabled));
        // Store in AdminSettings table with key-value pairs
    }

    private Color GetLogColor(string level) => level.ToUpper() switch
    {
        "ERROR" => Color.Error,
        "WARNING" => Color.Warning,
        "INFO" => Color.Info,
        _ => Color.Default
    };

    private async Task HandleClearLocalStorage()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Clear LocalStorage",
            "This will delete all locally stored data. Are you sure?",
            yesText: "Clear",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            Dispatcher.Dispatch(new ClearLocalStorageAction());
            Snackbar.Add("LocalStorage cleared", Severity.Warning);
        }
    }

    private async Task HandleClearIndexedDB()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Clear IndexedDB",
            "This will delete all files stored in IndexedDB. Are you sure?",
            yesText: "Clear",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            Dispatcher.Dispatch(new ClearIndexedDBAction());
            Snackbar.Add("IndexedDB cleared", Severity.Warning);
        }
    }

    private void HandleRefreshLogs()
    {
        Dispatcher.Dispatch(new RefreshSystemLogsAction());
        Snackbar.Add("Logs refreshed", Severity.Success);
    }

    private void HandleClearLogs()
    {
        Dispatcher.Dispatch(new ClearSystemLogsAction());
        Snackbar.Add("Logs cleared", Severity.Success);
    }

    private void HandleExportLogs()
    {
        Dispatcher.Dispatch(new ExportSystemLogsAction());
        Snackbar.Add("Logs exported", Severity.Success);
    }

    private async Task HandleFactoryReset()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "⚠️ Factory Reset",
            "This is PERMANENT and will delete ALL data. Type 'RESET' to confirm.",
            yesText: "RESET",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            Dispatcher.Dispatch(new FactoryResetAction());
            Snackbar.Add("Factory reset initiated", Severity.Error);
        }
    }
}
