@using Fluxor
@using AiMate.Web.Store.Admin
@using AiMate.Shared.Models
@using AiMate.Core.Enums
@using AiMate.Web.Components.Dialogs
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<AdminState> AdminState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService

<MudStack Spacing="3">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h6">Global Model Configuration</MudText>
        <MudButton Variant="Variant.Filled"
                  Color="Color.Primary"
                  StartIcon="@Icons.Material.Filled.Add"
                  OnClick="@HandleAddModel">
            Add Model
        </MudButton>
    </MudStack>
    <MudDivider />

    <MudAlert Severity="Severity.Info">
        Configure models available to all users. Users can select their preferred model from this list.
    </MudAlert>

    @if (AdminState.Value.Models.Any())
    {
        <MudTable T="AIModelConfig" Items="@AdminState.Value.Models" Hover="true">
            <HeaderContent>
                <MudTh>Model</MudTh>
                <MudTh>Provider</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Max Tokens</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Model">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Id</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Provider">
                    <MudChip T="string" Size="Size.Small">@context.Provider</MudChip>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudSwitch T="bool" Checked="@context.IsEnabled"
                              Color="Color.Success"
                              CheckedChanged="@((bool val) => HandleToggleModel(context.Id))" />
                </MudTd>
                <MudTd DataLabel="Max Tokens">@context.MaxTokens</MudTd>
                <MudTd DataLabel="Actions">
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                      Size="Size.Small"
                                      OnClick="@(() => HandleEditModel(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                      Size="Size.Small"
                                      Color="Color.Error"
                                      OnClick="@(() => HandleDeleteModel(context.Id))" />
                    </MudStack>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else
    {
        <MudAlert Severity="Severity.Warning">No models configured. Add models to enable AI functionality.</MudAlert>
    }
</MudStack>

@code {
    private async Task HandleAddModel()
    {
        // Create new empty model DTO for admin (has full permissions)
        var newModel = new AIModelDto
        {
            Id = Guid.NewGuid().ToString(),
            Name = "",
            ModelId = "",
            Description = "",
            Connection = "default",
            Provider = "OpenAI",
            IsEnabled = true,
            ContextWindow = 8192,
            MaxTokens = 4096,
            Temperature = 0.7,
            TopP = 1.0,
            FrequencyPenalty = 0.0,
            PresencePenalty = 0.0,
            Visibility = "Public", // Admin models are public by default
            AllowedGroups = new List<string>()
        };

        var parameters = new DialogParameters
        {
            ["Model"] = newModel,
            ["UserTier"] = UserTier.Admin, // Admin has full access
            ["IsNew"] = true
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true,
            BackdropClick = false
        };

        var dialog = await DialogService.ShowAsync<EditModelDialog>("Add New Model", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is AIModelDto modelDto)
        {
            // Convert DTO back to AIModelConfig for AdminState
            var modelConfig = new AIModelConfig
            {
                Id = modelDto.Id,
                Name = modelDto.Name,
                Provider = modelDto.Provider,
                IsEnabled = modelDto.IsEnabled,
                MaxTokens = modelDto.MaxTokens,
                Description = modelDto.Description
            };

            Dispatcher.Dispatch(new AddModelAction(modelConfig));
        }
    }

    private async Task HandleEditModel(AIModelConfig model)
    {
        // Convert AIModelConfig to AIModelDto for the comprehensive dialog
        var modelDto = new AIModelDto
        {
            Id = model.Id,
            Name = model.Name,
            ModelId = model.Id, // Use Id as ModelId if not specified
            Description = model.Description ?? "",
            Connection = "default",
            Provider = model.Provider,
            IsEnabled = model.IsEnabled,
            ContextWindow = 8192, // Default values since AIModelConfig doesn't store these
            MaxTokens = model.MaxTokens,
            Temperature = 0.7,
            TopP = 1.0,
            FrequencyPenalty = 0.0,
            PresencePenalty = 0.0,
            SupportsVision = false,
            SupportsWebSearch = false,
            SupportsFileUpload = false,
            SupportsImageGeneration = false,
            Visibility = "Public", // Admin models are public
            AllowedGroups = new List<string>()
        };

        var parameters = new DialogParameters
        {
            ["Model"] = modelDto,
            ["UserTier"] = UserTier.Admin,
            ["IsNew"] = false
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true,
            BackdropClick = false
        };

        var dialog = await DialogService.ShowAsync<EditModelDialog>("Edit Model", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is AIModelDto updatedDto)
        {
            // Convert back to AIModelConfig
            var updatedConfig = new AIModelConfig
            {
                Id = updatedDto.Id,
                Name = updatedDto.Name,
                Provider = updatedDto.Provider,
                IsEnabled = updatedDto.IsEnabled,
                MaxTokens = updatedDto.MaxTokens,
                Description = updatedDto.Description
            };

            Dispatcher.Dispatch(new UpdateModelAction(updatedConfig));
        }
    }

    private void HandleToggleModel(string modelId)
    {
        Dispatcher.Dispatch(new ToggleModelAction(modelId));
    }

    private async Task HandleDeleteModel(string modelId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this model? Users will no longer be able to select it.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            Dispatcher.Dispatch(new DeleteModelAction(modelId));
        }
    }
}
