@* Mobile-first API Connections configuration *@

<div class="space-y-4 md:space-y-6">

    @* Header with Actions *@
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
            <h3 class="text-base md:text-lg font-semibold text-white">API Connections</h3>
            <p class="text-xs md:text-sm text-gray-400 mt-1">Manage API keys and provider connections</p>
        </div>
        <button @onclick="OpenAddConnectionModal"
                class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-all">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            <span>Add Connection</span>
        </button>
    </div>

    @* Connections List - Mobile: Cards, Desktop: Enhanced Cards *@
    <div class="space-y-3">
        @foreach (var connection in connections)
        {
            <div @key="connection.Id" class="p-4 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg hover:border-purple-500/50 transition-all">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3 flex-1">
                        @* Provider Icon *@
                        <div class="w-10 h-10 rounded-lg @GetProviderBgClass(connection.Provider) flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                @((MarkupString)GetProviderIcon(connection.Provider))
                            </svg>
                        </div>

                        @* Connection Info *@
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="text-white font-medium text-sm md:text-base truncate">@connection.Name</h4>
                                @if (connection.IsValid)
                                {
                                    <span class="px-2 py-0.5 bg-green-500/10 text-green-400 text-xs font-medium rounded flex-shrink-0">
                                        ✓ Valid
                                    </span>
                                }
                                else
                                {
                                    <span class="px-2 py-0.5 bg-red-500/10 text-red-400 text-xs font-medium rounded flex-shrink-0">
                                        ✗ Invalid
                                    </span>
                                }
                            </div>
                            <p class="text-gray-400 text-xs md:text-sm">@connection.Provider</p>
                        </div>
                    </div>

                    @* Actions *@
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <button @onclick="@(() => TestConnection(connection))"
                                class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Test Connection">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M5 12h14m-7-7l7 7-7 7"/>
                            </svg>
                        </button>
                        <button @onclick="@(() => OpenEditConnectionModal(connection))"
                                class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                            </svg>
                        </button>
                        <button @onclick="@(() => DeleteConnection(connection))"
                                class="p-2 text-gray-400 hover:text-red-400 hover:bg-[#2A2A2A] rounded-lg transition-all"
                                title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>

                @* API Key Preview (masked) *@
                <div class="flex items-center gap-2 text-xs text-gray-500 font-mono">
                    <span>API Key:</span>
                    <span class="flex-1 truncate">@MaskApiKey(connection.ApiKey)</span>
                    <button @onclick="@(() => CopyApiKey(connection))"
                            class="text-gray-400 hover:text-white transition-colors"
                            title="Copy">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@* Add/Edit Connection Modal *@
@if (showConnectionModal)
{
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4"
         @onclick="CloseConnectionModal">
        <div class="bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl w-full max-w-md"
             @onclick:stopPropagation="true">
            <div class="px-6 py-4 border-b border-[#2A2A2A]">
                <h3 class="text-lg font-semibold text-white">@(isEditMode ? "Edit Connection" : "Add New Connection")</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Provider</label>
                    <select @bind="editingConnection.Provider"
                            class="w-full px-3 py-2 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="OpenAI">OpenAI</option>
                        <option value="Anthropic">Anthropic</option>
                        <option value="Google">Google</option>
                        <option value="Azure">Azure OpenAI</option>
                        <option value="LiteLLM">LiteLLM Proxy</option>
                        <option value="Custom">Custom Endpoint</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Connection Name</label>
                    <input type="text"
                           @bind="editingConnection.Name"
                           class="w-full px-3 py-2 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="My OpenAI Connection">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">API Key</label>
                    <div class="relative">
                        <input type="@(showApiKey ? "text" : "password")"
                               @bind="editingConnection.ApiKey"
                               class="w-full px-3 py-2 pr-10 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="sk-...">
                        <button type="button"
                                @onclick="ToggleApiKeyVisibility"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                @if (showApiKey)
                                {
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                }
                                else
                                {
                                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                }
                            </svg>
                        </button>
                    </div>
                </div>

                @if (editingConnection.Provider == "Custom" || editingConnection.Provider == "LiteLLM")
                {
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Base URL</label>
                        <input type="text"
                               @bind="editingConnection.BaseUrl"
                               class="w-full px-3 py-2 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="https://api.example.com/v1">
                    </div>
                }
            </div>
            <div class="px-6 py-4 border-t border-[#2A2A2A] flex gap-3">
                <button @onclick="CloseConnectionModal"
                        class="flex-1 px-4 py-2 bg-[#0F0F0F] hover:bg-[#2A2A2A] text-gray-300 rounded-lg transition-all">
                    Cancel
                </button>
                <button @onclick="HandleSaveConnection"
                        class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all">
                    Save
                </button>
            </div>
        </div>
    </div>
}

@code {
    private bool showConnectionModal = false;
    private bool isEditMode = false;
    private bool showApiKey = false;
    private ApiConnection editingConnection = new();

    private List<ApiConnection> connections = new()
    {
        new ApiConnection { Id = "1", Name = "Production OpenAI", Provider = "OpenAI", ApiKey = "sk-1234567890abcdef", IsValid = true },
        new ApiConnection { Id = "2", Name = "Anthropic Claude", Provider = "Anthropic", ApiKey = "sk-ant-1234567890", IsValid = true },
        new ApiConnection { Id = "3", Name = "Test Connection", Provider = "Custom", ApiKey = "test-key", BaseUrl = "http://localhost:8000", IsValid = false }
    };

    private void OpenAddConnectionModal()
    {
        isEditMode = false;
        showApiKey = false;
        editingConnection = new ApiConnection();
        showConnectionModal = true;
    }

    private void OpenEditConnectionModal(ApiConnection connection)
    {
        isEditMode = true;
        showApiKey = false;
        editingConnection = new ApiConnection
        {
            Id = connection.Id,
            Name = connection.Name,
            Provider = connection.Provider,
            ApiKey = connection.ApiKey,
            BaseUrl = connection.BaseUrl,
            IsValid = connection.IsValid
        };
        showConnectionModal = true;
    }

    private void CloseConnectionModal()
    {
        showConnectionModal = false;
    }

    private void ToggleApiKeyVisibility()
    {
        showApiKey = !showApiKey;
    }

    private async Task HandleSaveConnection()
    {
        // TODO: Save connection
        CloseConnectionModal();
        await Task.CompletedTask;
    }

    private async Task TestConnection(ApiConnection connection)
    {
        // TODO: Test API connection
        await Task.CompletedTask;
    }

    private void DeleteConnection(ApiConnection connection)
    {
        // TODO: Confirm and delete
        connections.Remove(connection);
    }

    private async Task CopyApiKey(ApiConnection connection)
    {
        // TODO: Copy to clipboard
        await Task.CompletedTask;
    }

    private string MaskApiKey(string apiKey)
    {
        if (string.IsNullOrEmpty(apiKey) || apiKey.Length < 8)
            return "••••••••";
        return $"{apiKey.Substring(0, 7)}...{apiKey.Substring(apiKey.Length - 4)}";
    }

    private string GetProviderBgClass(string provider) => provider switch
    {
        "OpenAI" => "bg-gradient-to-br from-green-500 to-emerald-600",
        "Anthropic" => "bg-gradient-to-br from-orange-500 to-red-600",
        "Google" => "bg-gradient-to-br from-blue-500 to-indigo-600",
        "Azure" => "bg-gradient-to-br from-blue-400 to-cyan-500",
        "LiteLLM" => "bg-gradient-to-br from-purple-500 to-pink-600",
        _ => "bg-gradient-to-br from-gray-500 to-gray-600"
    };

    private string GetProviderIcon(string provider) => "<path d=\"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71\"/><path d=\"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71\"/>";

    public class ApiConnection
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Provider { get; set; } = "OpenAI";
        public string ApiKey { get; set; } = string.Empty;
        public string BaseUrl { get; set; } = string.Empty;
        public bool IsValid { get; set; }
    }
}
