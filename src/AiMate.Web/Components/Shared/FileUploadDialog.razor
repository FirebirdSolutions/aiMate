@using AiMate.Core.Services
@inject IFileUploadService FileUploadService

@if (IsVisible)
{
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="HandleCancel">
        <div class="bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl w-full max-w-2xl"
             @onclick:stopPropagation="true">

            @* Dialog Header *@
            <div class="flex items-center justify-between px-6 py-4 border-b border-[#2A2A2A]">
                <h3 class="text-lg font-semibold text-white">Upload Files</h3>
                <button @onclick="HandleCancel"
                        class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            @* Dialog Content *@
            <div class="p-6 space-y-4">
                @* File Upload Button *@
                <div>
                    <label for="file-upload" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all cursor-pointer text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
                        </svg>
                        Choose Files
                    </label>
                    <input id="file-upload"
                           type="file"
                           multiple
                           accept=".txt,.md,.pdf,.png,.jpg,.jpeg,.doc,.docx"
                           @* @onchange="OnFilesChanged" *@
                           class="hidden" />
                </div>

                @* Selected Files List *@
                @if (_selectedFiles.Any())
                {
                    <div class="space-y-2 mt-4">
                        @foreach (var file in _selectedFiles)
                        {
                            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-3 flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-white truncate">@file.Name</p>
                                    <p class="text-xs text-gray-400">@FormatFileSize(file.Size)</p>
                                </div>
                                <button @onclick="@(() => RemoveFile(file))"
                                        class="ml-3 p-1 text-gray-400 hover:text-red-400 hover:bg-[#2A2A2A] rounded transition-all">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                }

                @* Upload Progress *@
                @if (_isUploading)
                {
                    <div class="mt-4">
                        <div class="w-full h-1 bg-[#0F0F0F] rounded-full overflow-hidden">
                            <div class="h-full bg-purple-600 animate-pulse" style="animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;"></div>
                        </div>
                        <p class="text-xs text-gray-400 text-center mt-2">Uploading files...</p>
                    </div>
                }

                @* Info Alert *@
                <div class="bg-blue-500/10 border border-blue-500/50 rounded-lg p-3 flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/>
                    </svg>
                    <p class="text-sm text-blue-400">
                        Max file size: @(FileUploadService.GetFileSizeLimit() / 1024 / 1024)MB per file. Maximum 5 files.
                    </p>
                </div>

                @* Error Message *@
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="bg-red-500/10 border border-red-500/50 rounded-lg p-3 flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                        </svg>
                        <p class="text-sm text-red-400">@_errorMessage</p>
                    </div>
                }

                @* Success Message *@
                @if (!string.IsNullOrEmpty(_successMessage))
                {
                    <div class="bg-green-500/10 border border-green-500/50 rounded-lg p-3 flex items-start gap-3">
                        <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-sm text-green-400">@_successMessage</p>
                    </div>
                }
            </div>

            @* Dialog Actions *@
            <div class="px-6 py-4 border-t border-[#2A2A2A] flex items-center justify-end gap-3">
                <button @onclick="HandleCancel"
                        class="px-4 py-2 bg-transparent border border-[#2A2A2A] text-gray-300 hover:bg-[#2A2A2A] rounded-lg transition-all text-sm font-medium">
                    Cancel
                </button>
                <button @onclick="HandleUpload"
                        disabled="@(!_selectedFiles.Any() || _isUploading)"
                        class="@(_selectedFiles.Any() && !_isUploading ? "bg-purple-600 hover:bg-purple-700" : "bg-gray-700 cursor-not-allowed") px-4 py-2 text-white rounded-lg transition-all text-sm font-medium">
                    Upload (@_selectedFiles.Count)
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public Guid WorkspaceId { get; set; }

    [Parameter]
    public EventCallback<object?> OnUploadComplete { get; set; }

    private List<IBrowserFile> _selectedFiles = new();
    private bool _isUploading = false;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;

    private void OnFilesChanged(InputFileChangeEventArgs e)
    {
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        var files = e.GetMultipleFiles(5); // Max 5 files
        _selectedFiles = files.ToList();
    }

    private void RemoveFile(IBrowserFile file)
    {
        _selectedFiles.Remove(file);
        _errorMessage = string.Empty;
        _successMessage = string.Empty;
    }

    private async Task HandleUpload()
    {
        if (!_selectedFiles.Any())
        {
            return;
        }

        _isUploading = true;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        try
        {
            foreach (var file in _selectedFiles)
            {
                using var stream = file.OpenReadStream(FileUploadService.GetFileSizeLimit());

                await FileUploadService.UploadFileAsync(
                    WorkspaceId,
                    file.Name,
                    stream,
                    file.ContentType);
            }

            _successMessage = $"Successfully uploaded {_selectedFiles.Count} file(s)";
            Console.WriteLine(_successMessage);

            _selectedFiles.Clear();

            // Wait a moment to show success message
            await Task.Delay(1500);

            await IsVisibleChanged.InvokeAsync(false);
            await OnUploadComplete.InvokeAsync(null);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Upload failed: {ex.Message}";
            Console.WriteLine(_errorMessage);
        }
        finally
        {
            _isUploading = false;
        }
    }

    private async Task HandleCancel()
    {
        _selectedFiles.Clear();
        _errorMessage = string.Empty;
        _successMessage = string.Empty;
        await IsVisibleChanged.InvokeAsync(false);
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;

        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }

        return $"{len:0.##} {sizes[order]}";
    }
}
