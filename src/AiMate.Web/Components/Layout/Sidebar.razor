@using Fluxor
@using AiMate.Web.Store.Chat
@using AiMate.Web.Store.Project
@using AiMate.Web.Store.Knowledge
@using AiMate.Web.Store.Workspace
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<ChatState> ChatState
@inject IState<ProjectState> ProjectState
@inject IState<KnowledgeState> KnowledgeState
@inject IState<WorkspaceState> WorkspaceState
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<aside class="w-[280px] bg-[#1A1A1A] border-r border-[#2A2A2A] flex flex-col h-screen">

    @* Logo Header *@
    <div class="p-4 border-b border-[#2A2A2A]">
        <div class="flex items-center gap-2 text-lg font-semibold">
            <svg class="w-6 h-6 text-purple-500" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 18c-3.87-.96-7-5.38-7-10V8.3l7-3.89 7 3.89V10c0 4.62-3.13 9.04-7 10z"/>
                <path d="M10.9 11.9l-1.4 1.4 4.2 4.2 5.6-5.6-1.4-1.4-4.2 4.2z"/>
            </svg>
            <span class="bg-gradient-to-r from-purple-500 to-blue-500 bg-clip-text text-transparent">
                aiMate
            </span>
        </div>
    </div>

    @* Scrollable Content *@
    <div class="flex-1 overflow-y-auto px-3 py-3">

        @* Start New Chat *@
        <div class="mb-6">
            <a href="/" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                <span class="text-sm">Start a new chat</span>
            </a>
        </div>

        @* Quick Actions *@
        <div class="mb-6">
            <a href="/search" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <span class="text-sm">Search</span>
            </a>

            <a href="/notes" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span class="text-sm">Notes</span>
            </a>

            <a href="/files" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                    <polyline points="13 2 13 9 20 9"/>
                </svg>
                <span class="text-sm">Files</span>
            </a>
        </div>

        @* Workspaces - Collapsible with Virtual List *@
        @if (WorkspaceState.Value.Workspaces.Any())
        {
            <div class="mb-6">
                <div @onclick="ToggleWorkspaces" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                    </svg>
                    <span class="text-sm flex-1">Workspaces</span>
                    <span class="text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded">@WorkspaceState.Value.Workspaces.Count</span>
                    <svg class="w-4 h-4 transition-transform @(workspacesExpanded ? "rotate-180" : "")"
                         fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>

                @if (workspacesExpanded)
                {
                    <div class="ml-3 mt-1 space-y-0.5 max-h-[200px] overflow-y-auto">
                        @foreach (var workspace in WorkspaceState.Value.Workspaces.Values
                            .OrderByDescending(w => w.IsPinned)
                            .ThenByDescending(w => w.UpdatedAt)
                            .Take(20))
                        {
                            <div @key="workspace.Id" class="group relative">
                                <a href="@($"/workspaces/{workspace.Id}")"
                                   class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer text-sm">
                                    @if (workspace.IsPinned)
                                    {
                                        <svg class="w-3 h-3 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M16 12V4h1.5v-2h-11v2H8v8l-2 2v2h5v6h2v-6h5v-2l-2-2z"/>
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    }
                                    <span class="flex-1 truncate text-xs">@workspace.Name</span>
                                    <button @onclick="@(() => ToggleWorkspaceMenu(workspace.Id))" @onclick:stopPropagation="true"
                                            data-kebab-button
                                            class="opacity-0 group-hover:opacity-100 p-1 hover:bg-[#3A3A3A] rounded transition-opacity">
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                                            <circle cx="12" cy="5" r="2"/>
                                            <circle cx="12" cy="12" r="2"/>
                                            <circle cx="12" cy="19" r="2"/>
                                        </svg>
                                    </button>
                                </a>

                                @* Workspace Kebab Menu *@
                                @if (openWorkspaceMenuId == workspace.Id)
                                {
                                    <div class="absolute right-0 top-8 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-1 z-50 min-w-[160px]"
                                         data-kebab-menu
                                         @onclick:stopPropagation="true">
                                        <button @onclick="@(() => OpenWorkspace(workspace.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                <circle cx="12" cy="12" r="3"/>
                                            </svg>
                                            Open
                                        </button>
                                        <button @onclick="@(() => PinWorkspace(workspace.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M16 12V4h1.5v-2h-11v2H8v8l-2 2v2h5v6h2v-6h5v-2l-2-2z"/>
                                            </svg>
                                            @(workspace.IsPinned ? "Unpin" : "Pin")
                                        </button>
                                        <button @onclick="@(() => EditWorkspace(workspace.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                                            </svg>
                                            Edit
                                        </button>
                                        <button @onclick="@(() => ArchiveWorkspace(workspace.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <polyline points="21 8 21 21 3 21 3 8"/>
                                                <rect x="1" y="3" width="22" height="5"/>
                                                <line x1="10" y1="12" x2="14" y2="12"/>
                                            </svg>
                                            @(workspace.IsArchived ? "Unarchive" : "Archive")
                                        </button>
                                        <div class="h-px bg-[#2A2A2A] my-1"></div>
                                        <button @onclick="@(() => DeleteWorkspace(workspace.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-red-400 hover:bg-[#2A2A2A] hover:text-red-300 transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }

        @* Knowledge - Collapsible with Virtual List *@
        @if (KnowledgeState.Value.KnowledgeItems.Any())
        {
            <div class="mb-6">
                <div @onclick="ToggleKnowledge" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                    <span class="text-sm flex-1">Knowledge</span>
                    <span class="text-xs bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded">@KnowledgeState.Value.KnowledgeItems.Count</span>
                    <svg class="w-4 h-4 transition-transform @(knowledgeExpanded ? "rotate-180" : "")"
                         fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>

                @if (knowledgeExpanded)
                {
                    <div class="ml-3 mt-1 space-y-0.5 max-h-[200px] overflow-y-auto">
                        @foreach (var item in KnowledgeState.Value.KnowledgeItems.Values
                            .OrderByDescending(k => k.IsPinned)
                            .ThenByDescending(k => k.UpdatedAt)
                            .Take(20))
                        {
                            <div @key="item.Id" class="group relative">
                                <a href="@($"/knowledge/{item.Id}")"
                                   class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer text-sm">
                                    @if (item.IsPinned)
                                    {
                                        <svg class="w-3 h-3 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M16 12V4h1.5v-2h-11v2H8v8l-2 2v2h5v6h2v-6h5v-2l-2-2z"/>
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                                        </svg>
                                    }
                                    <span class="flex-1 truncate text-xs">@item.Title</span>
                                    <button @onclick="@(() => ToggleKnowledgeMenu(item.Id))" @onclick:stopPropagation="true"
                                            data-kebab-button
                                            class="opacity-0 group-hover:opacity-100 p-1 hover:bg-[#3A3A3A] rounded transition-opacity">
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                                            <circle cx="12" cy="5" r="2"/>
                                            <circle cx="12" cy="12" r="2"/>
                                            <circle cx="12" cy="19" r="2"/>
                                        </svg>
                                    </button>
                                </a>

                                @* Knowledge Kebab Menu *@
                                @if (openKnowledgeMenuId == item.Id)
                                {
                                    <div class="absolute right-0 top-8 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-1 z-50 min-w-[160px]"
                                         data-kebab-menu
                                         @onclick:stopPropagation="true">
                                        <button @onclick="@(() => ViewKnowledge(item.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                <circle cx="12" cy="12" r="3"/>
                                            </svg>
                                            View
                                        </button>
                                        <button @onclick="@(() => PinKnowledge(item.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M16 12V4h1.5v-2h-11v2H8v8l-2 2v2h5v6h2v-6h5v-2l-2-2z"/>
                                            </svg>
                                            @(item.IsPinned ? "Unpin" : "Pin")
                                        </button>
                                        <button @onclick="@(() => EditKnowledge(item.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                                            </svg>
                                            Edit
                                        </button>
                                        <button @onclick="@(() => ShareKnowledge(item.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <circle cx="18" cy="5" r="3"/>
                                                <circle cx="6" cy="12" r="3"/>
                                                <circle cx="18" cy="19" r="3"/>
                                                <path d="m8.59 13.51 6.83 3.98m-.01-10.98-6.82 3.98"/>
                                            </svg>
                                            Share
                                        </button>
                                        <div class="h-px bg-[#2A2A2A] my-1"></div>
                                        <button @onclick="@(() => DeleteKnowledge(item.Id))" class="flex items-center gap-2 px-3 py-1.5 text-xs text-red-400 hover:bg-[#2A2A2A] hover:text-red-300 transition-all w-full text-left">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }

        @* Projects - Collapsible *@
        <div class="mb-6">
            <div @onclick="ToggleProjects" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer mb-1">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                <span class="text-sm flex-1">Projects</span>
                <svg class="w-4 h-4 transition-transform @(projectsExpanded ? "rotate-180" : "")"
                     fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>

            @if (projectsExpanded)
            {
                <div class="ml-6 mt-1 space-y-1">
                    <a href="/projects" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        <span>New Project</span>
                    </a>

                    @foreach (var project in ProjectState.Value.Projects.Values.Take(5))
                    {
                        <a @key="project.Id" href="@($"/projects/{project.Id}")" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            </svg>
                            <span>@project.Name</span>
                        </a>
                    }
                </div>
            }
        </div>

        @* Recent Conversations - Virtual List with Kebab Menu *@
        @if (ChatState.Value.Conversations.Any())
        {
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2 px-3">
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Recent Chats</div>
                    <span class="text-xs bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded">
                        @ChatState.Value.Conversations.Values.Count(c => !c.IsArchived)
                    </span>
                </div>

                <div class="space-y-0.5 max-h-[300px] overflow-y-auto">
                    @foreach (var conversation in ChatState.Value.Conversations.Values
                        .Where(c => !c.IsArchived)
                        .OrderByDescending(c => c.UpdatedAt)
                        .Take(20))
                    {
                        <div @key="conversation.Id" class="group relative">
                            <a href="@($"/chat/{conversation.Id}")"
                               class="flex items-center gap-2 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer">
                                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                                <span class="text-sm truncate flex-1">@(conversation.Title.Length > 25 ? conversation.Title.Substring(0, 25) + "..." : conversation.Title)</span>
                                <button @onclick="@(() => ToggleChatMenu(conversation.Id))" @onclick:stopPropagation="true"
                                        data-kebab-button
                                        class="opacity-0 group-hover:opacity-100 p-1 hover:bg-[#3A3A3A] rounded transition-opacity">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <circle cx="12" cy="5" r="2"/>
                                        <circle cx="12" cy="12" r="2"/>
                                        <circle cx="12" cy="19" r="2"/>
                                    </svg>
                                </button>
                            </a>

                            @* Chat Kebab Menu *@
                            @if (openChatMenuId == conversation.Id)
                            {
                                <div class="absolute right-0 top-10 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-1 z-50 min-w-[160px]"
                                     data-kebab-menu
                                     @onclick:stopPropagation="true">
                                    <button @onclick="@(() => OpenChat(conversation.Id))" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        Open
                                    </button>
                                    <button @onclick="@(() => RenameChat(conversation.Id))" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                                        </svg>
                                        Rename
                                    </button>
                                    <button @onclick="@(() => ShareChat(conversation.Id))" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <circle cx="18" cy="5" r="3"/>
                                            <circle cx="6" cy="12" r="3"/>
                                            <circle cx="18" cy="19" r="3"/>
                                            <path d="m8.59 13.51 6.83 3.98m-.01-10.98-6.82 3.98"/>
                                        </svg>
                                        Share
                                    </button>
                                    <button @onclick="@(() => ArchiveChat(conversation.Id))" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all w-full text-left">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <polyline points="21 8 21 21 3 21 3 8"/>
                                            <rect x="1" y="3" width="22" height="5"/>
                                            <line x1="10" y1="12" x2="14" y2="12"/>
                                        </svg>
                                        Archive
                                    </button>
                                    <div class="h-px bg-[#2A2A2A] my-1"></div>
                                    <button @onclick="@(() => DeleteChat(conversation.Id))" class="flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:bg-[#2A2A2A] hover:text-red-300 transition-all w-full text-left">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    @* User Menu at Bottom *@
    <div class="border-t border-[#2A2A2A] p-3">
        <div @onclick="ToggleUserMenu"
             class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-[#2A2A2A] transition-all cursor-pointer relative">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-sm font-semibold">
                JD
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-white truncate">John Doe</div>
                <div class="text-xs text-gray-400 truncate">john.doe@example.com</div>
            </div>
            <svg class="w-4 h-4 text-gray-400 transition-transform @(userMenuOpen ? "rotate-180" : "")"
                 fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <polyline points="18 15 12 9 6 15"/>
            </svg>
        </div>

        @* User Menu Dropdown *@
        @if (userMenuOpen)
        {
            <div class="absolute bottom-full left-3 right-3 mb-2 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-2 z-50">
                <a href="/settings" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                    </svg>
                    Settings
                </a>
                <a href="/archived" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="21 8 21 21 3 21 3 8"/>
                        <rect x="1" y="3" width="22" height="5"/>
                        <line x1="10" y1="12" x2="14" y2="12"/>
                    </svg>
                    Archived
                </a>
                <a href="/admin" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                    </svg>
                    Admin Panel
                </a>
                <a href="/about" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4m0-4h.01"/>
                    </svg>
                    About
                </a>
                <div class="h-px bg-[#2A2A2A] my-2"></div>
                <a href="/logout" class="flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-[#2A2A2A] hover:text-red-300 transition-all">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5-5-5m5 5H9"/>
                    </svg>
                    Logout
                </a>
            </div>
        }
    </div>
</aside>

@* Dialogs *@
<RenameDialog @bind-IsOpen="showRenameChatDialog"
              Title="Rename Chat"
              Label="Chat name"
              CurrentValue="@selectedChatName"
              Placeholder="Enter chat name..."
              OnSave="HandleRenameChatSave" />

<ShareDialog @bind-IsOpen="showShareChatDialog"
             Title="Share Chat"
             ItemName="@selectedChatName"
             ItemIcon="ðŸ’¬"
             OnGenerateLink="HandleShareChatGenerate" />

<DeleteDialog @bind-IsOpen="showDeleteChatDialog"
              Title="Delete Chat"
              ItemName="@selectedChatName"
              ItemIcon="ðŸ’¬"
              Consequences="@deleteChatConsequences"
              WarningMessage="This action cannot be undone."
              OnDelete="HandleDeleteChatConfirm" />

<RenameDialog @bind-IsOpen="showRenameWorkspaceDialog"
              Title="Rename Workspace"
              Label="Workspace name"
              CurrentValue="@selectedWorkspaceName"
              Placeholder="Enter workspace name..."
              OnSave="HandleRenameWorkspaceSave" />

<DeleteDialog @bind-IsOpen="showDeleteWorkspaceDialog"
              Title="Delete Workspace"
              ItemName="@selectedWorkspaceName"
              ItemIcon="ðŸ“"
              Consequences="@deleteWorkspaceConsequences"
              WarningMessage="This action cannot be undone."
              RequireConfirmation="true"
              OnDelete="HandleDeleteWorkspaceConfirm" />

<RenameDialog @bind-IsOpen="showRenameKnowledgeDialog"
              Title="Rename Knowledge Article"
              Label="Article title"
              CurrentValue="@selectedKnowledgeName"
              Placeholder="Enter article title..."
              OnSave="HandleRenameKnowledgeSave" />

<ShareDialog @bind-IsOpen="showShareKnowledgeDialog"
             Title="Share Knowledge Article"
             ItemName="@selectedKnowledgeName"
             ItemIcon="ðŸ“š"
             OnGenerateLink="HandleShareKnowledgeGenerate" />

<DeleteDialog @bind-IsOpen="showDeleteKnowledgeDialog"
              Title="Delete Knowledge Article"
              ItemName="@selectedKnowledgeName"
              ItemIcon="ðŸ“š"
              Consequences="@deleteKnowledgeConsequences"
              WarningMessage="This action cannot be undone."
              OnDelete="HandleDeleteKnowledgeConfirm" />

@code {
    private bool projectsExpanded = false;
    private bool userMenuOpen = false;
    private bool workspacesExpanded = false;
    private bool knowledgeExpanded = false;

    // Menu state for kebab menus
    private Guid? openChatMenuId = null;
    private Guid? openWorkspaceMenuId = null;
    private Guid? openKnowledgeMenuId = null;

    // Dialog state - Chat
    private bool showRenameChatDialog = false;
    private bool showShareChatDialog = false;
    private bool showDeleteChatDialog = false;
    private Guid selectedChatId = Guid.Empty;
    private string selectedChatName = string.Empty;
    private List<string> deleteChatConsequences = new();

    // Dialog state - Workspace
    private bool showRenameWorkspaceDialog = false;
    private bool showDeleteWorkspaceDialog = false;
    private Guid selectedWorkspaceId = Guid.Empty;
    private string selectedWorkspaceName = string.Empty;
    private List<string> deleteWorkspaceConsequences = new();

    // Dialog state - Knowledge
    private bool showRenameKnowledgeDialog = false;
    private bool showShareKnowledgeDialog = false;
    private bool showDeleteKnowledgeDialog = false;
    private Guid selectedKnowledgeId = Guid.Empty;
    private string selectedKnowledgeName = string.Empty;
    private List<string> deleteKnowledgeConsequences = new();

    private DotNetObjectReference<Sidebar>? dotNetHelper;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                dotNetHelper = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("sidebarHelper.initializeClickOutside", dotNetHelper);
                await JSRuntime.InvokeVoidAsync("sidebarHelper.initializeEscapeKey", dotNetHelper);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing sidebar JS: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public void CloseAllMenus()
    {
        openChatMenuId = null;
        openWorkspaceMenuId = null;
        openKnowledgeMenuId = null;
        StateHasChanged();
    }

    public new async ValueTask DisposeAsync()
    {
        dotNetHelper?.Dispose();
    }

    private void ToggleProjects()
    {
        projectsExpanded = !projectsExpanded;
    }

    private void ToggleUserMenu()
    {
        userMenuOpen = !userMenuOpen;
    }

    private void ToggleWorkspaces()
    {
        workspacesExpanded = !workspacesExpanded;
    }

    private void ToggleKnowledge()
    {
        knowledgeExpanded = !knowledgeExpanded;
    }

    // Chat menu handlers
    private void ToggleChatMenu(Guid chatId)
    {
        openChatMenuId = openChatMenuId == chatId ? null : chatId;
    }

    private void OpenChat(Guid chatId)
    {
        Navigation.NavigateTo($"/chat/{chatId}");
        openChatMenuId = null;
    }

    private void RenameChat(Guid chatId)
    {
        var chat = ChatState.Value.Conversations.GetValueOrDefault(chatId);
        if (chat != null)
        {
            selectedChatId = chatId;
            selectedChatName = chat.Title;
            showRenameChatDialog = true;
        }
        openChatMenuId = null;
    }

    private void ShareChat(Guid chatId)
    {
        var chat = ChatState.Value.Conversations.GetValueOrDefault(chatId);
        if (chat != null)
        {
            selectedChatId = chatId;
            selectedChatName = chat.Title;
            showShareChatDialog = true;
        }
        openChatMenuId = null;
    }

    private void ArchiveChat(Guid chatId)
    {
        // TODO: Dispatch archive action
        Console.WriteLine($"Archive chat: {chatId}");
        openChatMenuId = null;
    }

    private void DeleteChat(Guid chatId)
    {
        var chat = ChatState.Value.Conversations.GetValueOrDefault(chatId);
        if (chat != null)
        {
            selectedChatId = chatId;
            selectedChatName = chat.Title;
            deleteChatConsequences = new List<string>
            {
                $"Permanently delete all messages in this chat",
                $"Remove any attachments or files associated with this chat",
                $"This chat will no longer appear in your history"
            };
            showDeleteChatDialog = true;
        }
        openChatMenuId = null;
    }

    // Workspace menu handlers
    private void ToggleWorkspaceMenu(Guid workspaceId)
    {
        openWorkspaceMenuId = openWorkspaceMenuId == workspaceId ? null : workspaceId;
    }

    private void OpenWorkspace(Guid workspaceId)
    {
        Navigation.NavigateTo($"/workspaces/{workspaceId}");
        openWorkspaceMenuId = null;
    }

    private void PinWorkspace(Guid workspaceId)
    {
        // TODO: Dispatch pin/unpin action
        Console.WriteLine($"Pin/Unpin workspace: {workspaceId}");
        openWorkspaceMenuId = null;
    }

    private void EditWorkspace(Guid workspaceId)
    {
        var workspace = WorkspaceState.Value.Workspaces.GetValueOrDefault(workspaceId);
        if (workspace != null)
        {
            selectedWorkspaceId = workspaceId;
            selectedWorkspaceName = workspace.Name;
            showRenameWorkspaceDialog = true;
        }
        openWorkspaceMenuId = null;
    }

    private void ArchiveWorkspace(Guid workspaceId)
    {
        // TODO: Dispatch archive action
        Console.WriteLine($"Archive workspace: {workspaceId}");
        openWorkspaceMenuId = null;
    }

    private void DeleteWorkspace(Guid workspaceId)
    {
        var workspace = WorkspaceState.Value.Workspaces.GetValueOrDefault(workspaceId);
        if (workspace != null)
        {
            selectedWorkspaceId = workspaceId;
            selectedWorkspaceName = workspace.Name;
            deleteWorkspaceConsequences = new List<string>
            {
                $"Permanently delete the workspace and all its settings",
                $"Remove all associated projects and configurations",
                $"This workspace will no longer be accessible"
            };
            showDeleteWorkspaceDialog = true;
        }
        openWorkspaceMenuId = null;
    }

    // Knowledge menu handlers
    private void ToggleKnowledgeMenu(Guid knowledgeId)
    {
        openKnowledgeMenuId = openKnowledgeMenuId == knowledgeId ? null : knowledgeId;
    }

    private void ViewKnowledge(Guid knowledgeId)
    {
        Navigation.NavigateTo($"/knowledge/{knowledgeId}");
        openKnowledgeMenuId = null;
    }

    private void PinKnowledge(Guid knowledgeId)
    {
        // TODO: Dispatch pin/unpin action
        Console.WriteLine($"Pin/Unpin knowledge: {knowledgeId}");
        openKnowledgeMenuId = null;
    }

    private void EditKnowledge(Guid knowledgeId)
    {
        var knowledge = KnowledgeState.Value.KnowledgeItems.GetValueOrDefault(knowledgeId);
        if (knowledge != null)
        {
            selectedKnowledgeId = knowledgeId;
            selectedKnowledgeName = knowledge.Title;
            showRenameKnowledgeDialog = true;
        }
        openKnowledgeMenuId = null;
    }

    private void ShareKnowledge(Guid knowledgeId)
    {
        var knowledge = KnowledgeState.Value.KnowledgeItems.GetValueOrDefault(knowledgeId);
        if (knowledge != null)
        {
            selectedKnowledgeId = knowledgeId;
            selectedKnowledgeName = knowledge.Title;
            showShareKnowledgeDialog = true;
        }
        openKnowledgeMenuId = null;
    }

    private void DeleteKnowledge(Guid knowledgeId)
    {
        var knowledge = KnowledgeState.Value.KnowledgeItems.GetValueOrDefault(knowledgeId);
        if (knowledge != null)
        {
            selectedKnowledgeId = knowledgeId;
            selectedKnowledgeName = knowledge.Title;
            deleteKnowledgeConsequences = new List<string>
            {
                $"Permanently delete this knowledge article and all its content",
                $"Remove any references to this article in chats",
                $"This article will no longer be searchable"
            };
            showDeleteKnowledgeDialog = true;
        }
        openKnowledgeMenuId = null;
    }

    // Dialog handlers - Chat
    private async Task HandleRenameChatSave(string newName)
    {
        // TODO: Dispatch rename action
        Console.WriteLine($"Renaming chat {selectedChatId} to: {newName}");
        showRenameChatDialog = false;
    }

    private async Task HandleShareChatGenerate(ShareDialog.ShareType shareType)
    {
        // TODO: Generate share link
        Console.WriteLine($"Generating {shareType} share link for chat {selectedChatId}");
    }

    private async Task HandleDeleteChatConfirm()
    {
        // TODO: Dispatch delete action
        Console.WriteLine($"Deleting chat: {selectedChatId}");
        showDeleteChatDialog = false;
    }

    // Dialog handlers - Workspace
    private async Task HandleRenameWorkspaceSave(string newName)
    {
        // TODO: Dispatch rename action
        Console.WriteLine($"Renaming workspace {selectedWorkspaceId} to: {newName}");
        showRenameWorkspaceDialog = false;
    }

    private async Task HandleDeleteWorkspaceConfirm()
    {
        // TODO: Dispatch delete action
        Console.WriteLine($"Deleting workspace: {selectedWorkspaceId}");
        showDeleteWorkspaceDialog = false;
    }

    // Dialog handlers - Knowledge
    private async Task HandleRenameKnowledgeSave(string newName)
    {
        // TODO: Dispatch rename action
        Console.WriteLine($"Renaming knowledge {selectedKnowledgeId} to: {newName}");
        showRenameKnowledgeDialog = false;
    }

    private async Task HandleShareKnowledgeGenerate(ShareDialog.ShareType shareType)
    {
        // TODO: Generate share link
        Console.WriteLine($"Generating {shareType} share link for knowledge {selectedKnowledgeId}");
    }

    private async Task HandleDeleteKnowledgeConfirm()
    {
        // TODO: Dispatch delete action
        Console.WriteLine($"Deleting knowledge: {selectedKnowledgeId}");
        showDeleteKnowledgeDialog = false;
    }
}
