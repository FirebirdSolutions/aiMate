@using Fluxor
@using AiMate.Web.Store.Chat
@using AiMate.Web.Store.Auth
@using AiMate.Web.Store.Workspace
@using Microsoft.JSInterop
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<ChatState> ChatState
@inject IState<AuthState> AuthState
@inject IState<WorkspaceState> WorkspaceState
@inject IDispatcher Dispatcher
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<header class="h-14 bg-[#1A1A1A] border-b border-[#2A2A2A] flex items-center justify-between px-6 relative">

    @* Left Side - Breadcrumbs & Context *@
    <div class="flex items-center gap-4 flex-1 min-w-0">
        @* Current Workspace Indicator *@
        @if (WorkspaceState.Value.ActiveWorkspaceId != null && WorkspaceState.Value.Workspaces.TryGetValue(WorkspaceState.Value.ActiveWorkspaceId.Value, out var workspace))
        {
            <div class="flex items-center gap-2 px-3 py-1.5 bg-purple-500/10 border border-purple-500/20 rounded-lg">
                <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
                <span class="text-xs font-medium text-purple-300 truncate max-w-[120px]">@workspace.Name</span>
            </div>
        }

        @* Breadcrumbs *@
        <nav class="flex items-center gap-2 text-sm">
            @if (!string.IsNullOrEmpty(PageTitle))
            {
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
                <span class="text-gray-400 font-medium">@PageTitle</span>
            }
        </nav>

        @* Model Selector *@
        <div class="relative ml-auto" @onclick="ToggleModelMenu">
            <button class="flex items-center gap-2 px-3 py-1.5 bg-[#242424] border border-[#2A2A2A] rounded-lg hover:bg-[#2A2A2A] transition-all cursor-pointer"
                    data-dropdown-button>
                <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z"/>
                    <path d="M18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z"/>
                </svg>
                <span class="text-xs font-medium text-white">@SelectedModel</span>
                <svg class="w-3 h-3 text-gray-400 transition-transform @(modelMenuOpen ? "rotate-180" : "")"
                     fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </button>

            @* Model Dropdown *@
            @if (modelMenuOpen)
            {
                <div class="absolute top-full left-0 mt-2 w-56 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-2 z-50"
                     data-dropdown-menu
                     @onclick:stopPropagation="true">
                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">OpenAI</div>
                    <a @onclick="@(() => SelectModel("GPT-4"))" class="flex items-center px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer">
                        GPT-4
                    </a>
                    <a @onclick="@(() => SelectModel("GPT-3.5 Turbo"))" class="flex items-center px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer">
                        GPT-3.5 Turbo
                    </a>

                    <div class="h-px bg-[#2A2A2A] my-2"></div>

                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Anthropic</div>
                    <a @onclick="@(() => SelectModel("Claude 3.5 Sonnet"))" class="flex items-center px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer">
                        Claude 3.5 Sonnet
                    </a>
                    <a @onclick="@(() => SelectModel("Claude 3 Opus"))" class="flex items-center px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer">
                        Claude 3 Opus
                    </a>

                    <div class="h-px bg-[#2A2A2A] my-2"></div>

                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Google</div>
                    <a @onclick="@(() => SelectModel("Gemini Pro"))" class="flex items-center px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all cursor-pointer">
                        Gemini Pro
                    </a>
                </div>
            }
        </div>
    </div>

    @* Right Side - Actions & User Menu *@
    <div class="flex items-center gap-2 ml-4">
        @* Search Button *@
        <button @onclick="ToggleSearch"
                class="flex items-center gap-2 px-3 py-1.5 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all group"
                title="Search (Ctrl+K)">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <span class="text-xs hidden lg:block">Search</span>
            <kbd class="hidden lg:block px-1.5 py-0.5 text-[10px] bg-[#2A2A2A] border border-[#3A3A3A] rounded">⌘K</kbd>
        </button>

        @* Notifications *@
        <div class="relative">
            <button @onclick="ToggleNotifications"
                    class="relative p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all"
                    data-dropdown-button
                    title="Notifications">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                @if (UnreadNotifications > 0)
                {
                    <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                }
            </button>

            @* Notifications Dropdown *@
            @if (notificationsOpen)
            {
                <div class="absolute top-full right-0 mt-2 w-80 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl z-50"
                     data-dropdown-menu
                     @onclick:stopPropagation="true">
                    <div class="flex items-center justify-between px-4 py-3 border-b border-[#2A2A2A]">
                        <h3 class="text-sm font-semibold text-white">Notifications</h3>
                        @if (UnreadNotifications > 0)
                        {
                            <span class="text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded">@UnreadNotifications new</span>
                        }
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        @if (notifications.Any())
                        {
                            @foreach (var notification in notifications.Take(5))
                            {
                                <div class="px-4 py-3 hover:bg-[#2A2A2A] transition-all border-b border-[#2A2A2A] last:border-b-0">
                                    <div class="flex items-start gap-3">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center">
                                            <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm text-gray-300">@notification.Message</p>
                                            <p class="text-xs text-gray-500 mt-1">@notification.Time</p>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="px-4 py-8 text-center">
                                <svg class="w-12 h-12 mx-auto text-gray-600 mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                    <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z"/>
                                </svg>
                                <p class="text-sm text-gray-500">No notifications</p>
                            </div>
                        }
                    </div>
                    @if (notifications.Any())
                    {
                        <div class="px-4 py-2 border-t border-[#2A2A2A]">
                            <a href="/notifications" class="text-xs text-purple-400 hover:text-purple-300 font-medium">View all notifications →</a>
                        </div>
                    }
                </div>
            }
        </div>

        @* New Chat Button *@
        <button @onclick="OnNewChat"
                class="flex items-center gap-2 px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-medium text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            <span class="hidden sm:inline">New Chat</span>
        </button>

        @* User Menu *@
        <div class="relative">
            <button @onclick="ToggleUserMenu"
                    class="flex items-center gap-2 p-1 hover:bg-[#2A2A2A] rounded-lg transition-all"
                    data-dropdown-button>
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-xs font-semibold">
                    @GetUserInitials()
                </div>
            </button>

            @* User Dropdown *@
            @if (userMenuOpen)
            {
                <div class="absolute top-full right-0 mt-2 w-56 bg-[#242424] border border-[#2A2A2A] rounded-lg shadow-2xl py-2 z-50"
                     data-dropdown-menu
                     @onclick:stopPropagation="true">
                    <div class="px-4 py-3 border-b border-[#2A2A2A]">
                        <p class="text-sm font-medium text-white">@GetUserName()</p>
                        <p class="text-xs text-gray-400 mt-0.5">@GetUserEmail()</p>
                    </div>

                    <a href="/profile" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                        Your Profile
                    </a>

                    <a href="/settings" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                        </svg>
                        Settings
                    </a>

                    <a href="/billing" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <rect x="2" y="5" width="20" height="14" rx="2"/>
                            <line x1="2" y1="10" x2="22" y2="10"/>
                        </svg>
                        Billing
                    </a>

                    <div class="h-px bg-[#2A2A2A] my-2"></div>

                    <a href="/help" class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-[#2A2A2A] hover:text-white transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3m.08 4h.01"/>
                        </svg>
                        Help & Support
                    </a>

                    <div class="h-px bg-[#2A2A2A] my-2"></div>

                    <a @onclick="Logout" class="flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-[#2A2A2A] hover:text-red-300 transition-all cursor-pointer">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5-5-5m5 5H9"/>
                        </svg>
                        Logout
                    </a>
                </div>
            }
        </div>
    </div>

    @* Search Modal Overlay *@
    @if (searchOpen)
    {
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-start justify-center pt-20"
             @onclick="ToggleSearch">
            <div class="w-full max-w-2xl bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl"
                 @onclick:stopPropagation="true">
                <div class="p-4 border-b border-[#2A2A2A]">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <input type="text"
                               @bind="searchQuery"
                               @bind:event="oninput"
                               placeholder="Search conversations, knowledge, files..."
                               class="flex-1 bg-transparent text-white placeholder-gray-500 focus:outline-none"
                               autofocus />
                        <kbd class="px-2 py-1 text-xs bg-[#2A2A2A] border border-[#3A3A3A] rounded text-gray-400">ESC</kbd>
                    </div>
                </div>
                <div class="max-h-96 overflow-y-auto p-2">
                    @if (!string.IsNullOrWhiteSpace(searchQuery))
                    {
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Results</div>
                        <div class="text-sm text-gray-400 px-3 py-4">Searching for "@searchQuery"...</div>
                    }
                    else
                    {
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Recent Searches</div>
                        <div class="text-sm text-gray-500 px-3 py-4 text-center">No recent searches</div>
                    }
                </div>
            </div>
        </div>
    }
</header>

@code {
    private bool modelMenuOpen = false;
    private bool notificationsOpen = false;
    private bool userMenuOpen = false;
    private bool searchOpen = false;
    private string searchQuery = string.Empty;
    private DotNetObjectReference<TopBar>? dotNetHelper;

    // Page context
    private string PageTitle => GetPageTitle();

    // Mock notifications - Replace with actual notification state
    private List<Notification> notifications = new();
    private int UnreadNotifications => notifications.Count(n => !n.IsRead);

    private string SelectedModel => ChatState.Value.SelectedModel ?? "GPT-4";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                dotNetHelper = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("topBarHelper.initialize", dotNetHelper);

                // Load mock notifications
                LoadMockNotifications();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing TopBar JS: {ex.Message}");
            }
        }
    }

    private void LoadMockNotifications()
    {
        notifications = new List<Notification>
        {
            new Notification { Message = "Your workspace 'Project Alpha' has been updated", Time = "2 mins ago", IsRead = false },
            new Notification { Message = "New knowledge article added: 'Getting Started with AI'", Time = "1 hour ago", IsRead = false },
            new Notification { Message = "Chat archived: 'Q&A Session with Claude'", Time = "3 hours ago", IsRead = true }
        };
    }

    private string GetPageTitle()
    {
        var uri = new Uri(Navigation.Uri);
        var path = uri.AbsolutePath.ToLower();

        return path switch
        {
            "/" => "Chat",
            "/search" => "Search",
            "/notes" => "Notes",
            "/knowledge" => "Knowledge Base",
            "/files" => "Files",
            "/workspaces" => "Workspaces",
            "/projects" => "Projects",
            "/settings" => "Settings",
            "/admin" => "Admin Panel",
            "/archived" => "Archived Chats",
            _ when path.StartsWith("/chat/") => "Chat",
            _ when path.StartsWith("/workspace/") => "Workspace",
            _ when path.StartsWith("/knowledge/") => "Knowledge",
            _ when path.StartsWith("/project/") => "Project",
            _ => "aiMate"
        };
    }

    private string GetUserName()
    {
        return AuthState.Value.User?.Name ?? "John Doe";
    }

    private string GetUserEmail()
    {
        return AuthState.Value.User?.Email ?? "john.doe@example.com";
    }

    private string GetUserInitials()
    {
        var name = GetUserName();
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        if (parts.Length == 1 && parts[0].Length >= 2)
            return parts[0].Substring(0, 2).ToUpper();
        return "U";
    }

    // Menu toggles
    private void ToggleModelMenu()
    {
        CloseAllMenus();
        modelMenuOpen = !modelMenuOpen;
    }

    private void ToggleNotifications()
    {
        CloseAllMenus();
        notificationsOpen = !notificationsOpen;
    }

    private void ToggleUserMenu()
    {
        CloseAllMenus();
        userMenuOpen = !userMenuOpen;
    }

    private void ToggleSearch()
    {
        searchOpen = !searchOpen;
        if (!searchOpen)
        {
            searchQuery = string.Empty;
        }
    }

    [JSInvokable]
    public void CloseAllMenus()
    {
        bool wasOpen = modelMenuOpen || notificationsOpen || userMenuOpen;
        modelMenuOpen = false;
        notificationsOpen = false;
        userMenuOpen = false;
        if (wasOpen)
        {
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void HandleSearchShortcut()
    {
        ToggleSearch();
        StateHasChanged();
    }

    private void SelectModel(string model)
    {
        Dispatcher.Dispatch(new SelectModelAction(model));
        modelMenuOpen = false;
    }

    private void OnNewChat()
    {
        var action = new CreateConversationAction("New Chat");
        Dispatcher.Dispatch(action);
        Navigation.NavigateTo("/");
        StateHasChanged();
    }

    private void Logout()
    {
        Dispatcher.Dispatch(new LogoutAction());
        Navigation.NavigateTo("/login");
        userMenuOpen = false;
    }

    public async ValueTask DisposeAsync()
    {
        dotNetHelper?.Dispose();
    }

    // Notification model
    private class Notification
    {
        public string Message { get; set; } = string.Empty;
        public string Time { get; set; } = string.Empty;
        public bool IsRead { get; set; }
    }
}
