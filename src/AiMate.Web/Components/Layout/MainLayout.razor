@using AiMate.Web.Store.Auth
@using Fluxor
@inherits LayoutComponentBase
@implements IDisposable
@inject IDispatcher Dispatcher
@inject IState<AuthState> AuthState
@inject NavigationManager Navigation

@* Clean Tailwind-based layout - No MudBlazor *@

@if (AuthState.Value.IsAuthenticated && !IsLoginPage)
{
    <div class="flex h-screen bg-[#0F0F0F] text-white overflow-hidden">
        @* Sidebar *@
        <Sidebar />

        @* Main Content Area *@
        <div class="flex-1 flex flex-col overflow-hidden">
            @* Top Bar *@
            <TopBar />

            @* Chat Container *@
            <main class="flex-1 overflow-hidden">
                @Body
            </main>
        </div>
    </div>
}
else
{
    @* Login page - full width *@
    <div class="w-full h-screen">
        @Body
    </div>
}

@code {
    private bool IsLoginPage => Navigation.Uri.Contains("/login", StringComparison.OrdinalIgnoreCase);

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Subscribe to auth state changes FIRST
        AuthState.StateChanged += OnAuthStateChanged;

        // Then check authentication status (async - will update state when complete)
        Dispatcher.Dispatch(new CheckAuthAction());
    }

    public void Dispose()
    {
        AuthState.StateChanged -= OnAuthStateChanged;
    }
}
