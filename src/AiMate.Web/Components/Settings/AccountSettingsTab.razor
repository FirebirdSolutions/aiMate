@using Fluxor
@using AiMate.Web.Store.Settings
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<SettingsState> SettingsState
@inject IDispatcher Dispatcher

@* Mobile-first responsive Account Settings Tab *@

<div class="space-y-6 md:space-y-8">

    @* Section: Account Information *@
    <div>
        <h3 class="text-base md:text-lg font-semibold text-white mb-4">Account Information</h3>

        <div class="space-y-4">
            @* Email *@
            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                <label class="block text-sm font-medium text-white mb-2">Email</label>
                <input type="email"
                       @bind="_email"
                       @bind:after="@(() => Dispatcher.Dispatch(new UpdateEmailAction(_email)))"
                       class="w-full bg-[#1A1A1A] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                       placeholder="rich@example.com" />
            </div>

            @* Username *@
            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                <label class="block text-sm font-medium text-white mb-2">Username</label>
                <input type="text"
                       @bind="_username"
                       @bind:after="@(() => Dispatcher.Dispatch(new UpdateUsernameAction(_username)))"
                       class="w-full bg-[#1A1A1A] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                       placeholder="rich" />
            </div>

            @* Update Profile Button *@
            <div class="flex justify-start">
                <button @onclick="HandleUpdateProfile"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-all">
                    Update Profile
                </button>
            </div>
        </div>
    </div>

    @* Section: Password *@
    <div>
        <h3 class="text-base md:text-lg font-semibold text-white mb-4">Password</h3>

        <div class="space-y-4">
            @* Current Password *@
            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                <label class="block text-sm font-medium text-white mb-2">Current Password</label>
                <input type="password"
                       @bind="_currentPassword"
                       class="w-full bg-[#1A1A1A] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                       placeholder="Enter current password" />
            </div>

            @* New Password *@
            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                <label class="block text-sm font-medium text-white mb-2">New Password</label>
                <input type="password"
                       @bind="_newPassword"
                       class="w-full bg-[#1A1A1A] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                       placeholder="Enter new password" />
            </div>

            @* Confirm Password *@
            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                <label class="block text-sm font-medium text-white mb-2">Confirm Password</label>
                <input type="password"
                       @bind="_confirmPassword"
                       class="w-full bg-[#1A1A1A] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                       placeholder="Confirm new password" />
            </div>

            @* Change Password Button *@
            <div class="flex justify-start">
                <button @onclick="HandleChangePassword"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-all">
                    Change Password
                </button>
            </div>
        </div>
    </div>

    @* Section: Privacy & Data *@
    <div>
        <h3 class="text-base md:text-lg font-semibold text-white mb-4">Privacy & Data</h3>

        <div class="space-y-4">
            @* Allow Analytics Toggle *@
            <div class="flex items-center justify-between p-4 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg">
                <div class="flex-1">
                    <div class="text-sm font-medium text-white">Allow Analytics</div>
                    <div class="text-xs text-gray-400 mt-1">Help improve the app with anonymous usage data</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox"
                           @bind="_allowAnalytics"
                           @bind:after="@(() => Dispatcher.Dispatch(new UpdateAllowAnalyticsAction(_allowAnalytics)))"
                           class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                </label>
            </div>
        </div>
    </div>

</div>

@code {
    private string? _username = "rich";
    private string? _email = "rich@example.com";
    private string _currentPassword = "";
    private string _newPassword = "";
    private string _confirmPassword = "";
    private bool _allowAnalytics = true;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        _username = SettingsState.Value.Username;
        _email = SettingsState.Value.Email;
    }

    private void HandleUpdateProfile()
    {
        // Dispatch SaveSettingsAction to save all settings including updated username/email
        Dispatcher.Dispatch(new SaveSettingsAction());
        Console.WriteLine("Profile updated successfully");
    }

    private void HandleChangePassword()
    {
        // Validate passwords match
        if (_newPassword != _confirmPassword)
        {
            Console.WriteLine("Error: Passwords do not match");
            return;
        }

        if (string.IsNullOrWhiteSpace(_currentPassword) || string.IsNullOrWhiteSpace(_newPassword))
        {
            Console.WriteLine("Error: Please fill in all password fields");
            return;
        }

        // TODO: Implement password change via dedicated endpoint
        // For now, show a message that this feature needs backend implementation
        Console.WriteLine("Info: Password change feature coming soon - requires dedicated auth endpoint");

        // Clear password fields
        _currentPassword = "";
        _newPassword = "";
        _confirmPassword = "";
    }
}
