@using Fluxor
@using AiMate.Web.Store.Settings
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<SettingsState> SettingsState
@inject IDispatcher Dispatcher

<MudText Typo="Typo.h6" Class="mb-4">Usage & Cost Tracking</MudText>

<MudGrid Spacing="2">
    <MudItem xs="12">
        <MudSwitch T="bool" Value="@_trackUsage"
                  Label="Track Usage"
                  Color="Color.Primary"
                  ValueChanged="@((bool value) => { _trackUsage = value; Dispatcher.Dispatch(new UpdateTrackUsageAction(value)); })" />
        <MudText Typo="Typo.caption" Color="Color.Secondary">
            Track tokens used and estimated costs
        </MudText>
    </MudItem>

    <MudItem xs="12">
        <MudSwitch T="bool" Value="@_showCostEstimates"
                  Label="Show Cost Estimates"
                  Color="Color.Primary"
                  ValueChanged="@((bool value) => { _showCostEstimates = value; Dispatcher.Dispatch(new UpdateShowCostEstimatesAction(value)); })" />
        <MudText Typo="Typo.caption" Color="Color.Secondary">
            Display estimated cost for each message
        </MudText>
    </MudItem>

    <MudItem xs="12">
        <MudSwitch T="bool" Value="@_enableUsageAlerts"
                  Label="Enable Usage Alerts"
                  Color="Color.Primary"
                  ValueChanged="@((bool value) => { _enableUsageAlerts = value; Dispatcher.Dispatch(new UpdateUsageAlertsAction(value)); })" />
        <MudText Typo="Typo.caption" Color="Color.Secondary">
            Get notified when approaching monthly budget
        </MudText>
    </MudItem>

    <MudItem xs="12">
        <MudDivider Class="my-4" />
    </MudItem>

    <MudItem xs="12" md="6">
        <MudNumericField T="int" Value="@_monthlyBudget"
                        Label="Monthly Budget (NZD)"
                        Variant="Variant.Outlined"
                        Margin="Margin.Dense"
                        Min="0"
                        Max="1000"
                        Step="10"
                        ValueChanged="@((int value) => { _monthlyBudget = value; Dispatcher.Dispatch(new UpdateMonthlyBudgetAction(value)); })" />
        <MudText Typo="Typo.caption" Color="Color.Secondary">
            0 = unlimited (for BYOK users)
        </MudText>
    </MudItem>

    <MudItem xs="12">
        <MudDivider Class="my-4" />
    </MudItem>

    <MudItem xs="12">
        <MudText Typo="Typo.subtitle1" Class="mb-2">Current Month Usage</MudText>
    </MudItem>

    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="0">
            <MudGrid Spacing="2">
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Tokens Used</MudText>
                    <MudText Typo="Typo.h5">147,532</MudText>
                    <MudProgressLinear Value="60" Color="Color.Primary" Class="mt-2" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Estimated Cost</MudText>
                    <MudText Typo="Typo.h5">$4.23 NZD</MudText>
                    <MudProgressLinear Value="42" Color="Color.Success" Class="mt-2" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Conversations</MudText>
                    <MudText Typo="Typo.h5">23</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    <MudItem xs="12">
        <MudText Typo="Typo.subtitle2" Class="mb-2">Usage by Model</MudText>

        <MudSimpleTable Hover="true" Dense="true">
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Tokens</th>
                    <th>Cost</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>GPT-4</td>
                    <td>82,145</td>
                    <td>$2.87</td>
                </tr>
                <tr>
                    <td>Claude 3.5 Sonnet</td>
                    <td>45,231</td>
                    <td>$1.12</td>
                </tr>
                <tr>
                    <td>GPT-3.5 Turbo</td>
                    <td>20,156</td>
                    <td>$0.24</td>
                </tr>
            </tbody>
        </MudSimpleTable>
    </MudItem>

    <MudItem xs="12">
        <MudButton Variant="Variant.Text"
                  Color="Color.Primary"
                  StartIcon="@Icons.Material.Filled.Download">
            Export Usage Data
        </MudButton>
    </MudItem>
</MudGrid>

@code {
    private bool _trackUsage = true;
    private bool _showCostEstimates = true;
    private bool _enableUsageAlerts = true;
    private int _monthlyBudget = 0;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        _trackUsage = SettingsState.Value.TrackUsage;
        _showCostEstimates = SettingsState.Value.ShowCostEstimates;
        _enableUsageAlerts = SettingsState.Value.EnableUsageAlerts;
        _monthlyBudget = SettingsState.Value.MonthlyBudget;
    }
}
