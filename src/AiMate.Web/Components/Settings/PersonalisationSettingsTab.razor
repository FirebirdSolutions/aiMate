@using Fluxor
@using AiMate.Web.Store.Settings
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<SettingsState> SettingsState
@inject IDispatcher Dispatcher

@* Mobile-first responsive Personalisation Settings Tab *@

<div class="space-y-6 md:space-y-8">

    @* Section: AI Behavior *@
    <div>
        <h3 class="text-base md:text-lg font-semibold text-white mb-4">AI Behavior</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @* Creativity Level *@
            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                <label class="block text-sm font-medium text-white mb-2">Creativity Level</label>
                <select @bind="_creativityLevel"
                        @bind:after="@(() => UpdateTemperature())"
                        class="w-full bg-[#1A1A1A] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="balanced">Balanced</option>
                    <option value="precise">Precise</option>
                    <option value="creative">Creative</option>
                </select>
            </div>

            @* Response Style *@
            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                <label class="block text-sm font-medium text-white mb-2">Response Style</label>
                <select @bind="_responseStyle"
                        class="w-full bg-[#1A1A1A] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="balanced">Balanced</option>
                    <option value="concise">Concise</option>
                    <option value="detailed">Detailed</option>
                </select>
            </div>
        </div>
    </div>

    @* Section: Custom Instructions *@
    <div>
        <h3 class="text-base md:text-lg font-semibold text-white mb-4">Custom Instructions</h3>

        <div class="space-y-4">
            @* Additional Context *@
            <div class="bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg p-4">
                <label class="block text-sm font-medium text-white mb-2">Additional Context</label>
                <div class="text-xs text-gray-400 mb-2">Customize how the AI responds to you</div>
                <textarea @bind="_customInstructions"
                          @bind:after="@(() => Dispatcher.Dispatch(new UpdateSystemPromptOverrideAction(_customInstructions)))"
                          rows="6"
                          placeholder="e.g., Always respond in a friendly tone, use emojis occasionally..."
                          class="w-full bg-[#1A1A1A] border border-[#2A2A2A] text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none">
                </textarea>
            </div>

            @* Remember Conversation Context Toggle *@
            <div class="flex items-center justify-between p-4 bg-[#0F0F0F] border border-[#2A2A2A] rounded-lg">
                <div class="flex-1">
                    <div class="text-sm font-medium text-white">Remember conversation context</div>
                    <div class="text-xs text-gray-400 mt-1">AI remembers details from previous messages</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox"
                           @bind="_rememberContext"
                           @bind:after="@(() => Dispatcher.Dispatch(new UpdateRememberContextAction(_rememberContext)))"
                           class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                </label>
            </div>
        </div>
    </div>

</div>

@code {
    private string _creativityLevel = "balanced";
    private string _responseStyle = "balanced";
    private double _temperature = 0.7;
    private string _customInstructions = "";
    private bool _rememberContext = true;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        _temperature = SettingsState.Value.Temperature;
        _creativityLevel = _temperature switch
        {
            <= 0.5 => "precise",
            >= 1.0 => "creative",
            _ => "balanced"
        };
        _customInstructions = SettingsState.Value.SystemPromptOverride ?? "";
    }

    private void UpdateTemperature()
    {
        _temperature = _creativityLevel switch
        {
            "precise" => 0.3,
            "creative" => 1.2,
            _ => 0.7
        };
        Dispatcher.Dispatch(new UpdateTemperatureAction(_temperature));
    }
}
