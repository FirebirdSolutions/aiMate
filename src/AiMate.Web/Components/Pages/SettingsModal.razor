@inject IJSRuntime JSRuntime

@if (IsOpen)
{
    @* Modal Overlay *@
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @onclick="HandleOverlayClick">

        @* Modal Dialog *@
        <div class="bg-[#1A1A1A] border border-[#2A2A2A] rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"
             @onclick:stopPropagation="true">

            @* Header *@
            <div class="flex items-center justify-between px-6 py-4 border-b border-[#2A2A2A]">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-white">Settings</h2>
                        <p class="text-sm text-gray-400">Manage your application settings and preferences</p>
                    </div>
                </div>
                <button @onclick="Close"
                        class="p-2 text-gray-400 hover:text-white hover:bg-[#2A2A2A] rounded-lg transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            @* Error/Success Messages *@
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="mx-6 mt-4 p-4 bg-red-900/20 border border-red-500/50 rounded-lg flex items-start justify-between">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span class="text-sm text-red-200">@errorMessage</span>
                    </div>
                    <button @onclick="@(() => errorMessage = "")" class="text-red-400 hover:text-red-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            }

            @if (isSaving)
            {
                <div class="mx-6 mt-4 p-4 bg-blue-900/20 border border-blue-500/50 rounded-lg flex items-center gap-3">
                    <svg class="animate-spin w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm text-blue-200">Saving settings...</span>
                </div>
            }

            @* Horizontal Tab Navigation *@
            <div class="border-b border-[#2A2A2A] overflow-x-auto scrollbar-thin scrollbar-thumb-[#2A2A2A] scrollbar-track-transparent">
                <div class="flex px-6 min-w-max">
                    @foreach (var tab in tabs)
                    {
                        <button @onclick="@(() => SelectTab(tab.Id))"
                                class="flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-all whitespace-nowrap
                                       @(activeTab == tab.Id ? "border-purple-500 text-white" : "border-transparent text-gray-400 hover:text-white hover:bg-[#2A2A2A]/50")">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                @((MarkupString)tab.Icon)
                            </svg>
                            <span>@tab.Name</span>
                        </button>
                    }
                </div>
            </div>

            @* Tab Content *@
            <div class="flex-1 overflow-y-auto p-6">
                @switch (activeTab)
                {
                    case "general":
                        <GeneralSettingsTab />
                        break;
                    case "interface":
                        <InterfaceSettingsTab />
                        break;
                    case "connections":
                        <ConnectionsSettingsTab />
                        break;
                    case "personalisation":
                        <PersonalisationSettingsTab />
                        break;
                    case "account":
                        <AccountSettingsTab />
                        break;
                    case "usage":
                        <UsageSettingsTab />
                        break;
                }
            </div>

            @* Footer Actions *@
            <div class="border-t border-[#2A2A2A] px-6 py-4 flex items-center justify-between gap-4">
                <button @onclick="HandleCancel"
                        class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white bg-transparent border border-[#2A2A2A] hover:bg-[#2A2A2A] rounded-lg transition-all">
                    Cancel
                </button>

                <div class="flex items-center gap-3">
                    <button @onclick="HandleReset"
                            class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white bg-transparent hover:bg-red-900/20 border border-[#2A2A2A] hover:border-red-500/50 rounded-lg transition-all">
                        Reset to Defaults
                    </button>

                    <button @onclick="HandleSave"
                            disabled="@isSaving"
                            class="px-6 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 disabled:bg-purple-600/50 disabled:cursor-not-allowed rounded-lg transition-all flex items-center gap-2">
                        @if (isSaving)
                        {
                            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            <span>Save Settings</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private string activeTab = "general";
    private bool isSaving = false;
    private string errorMessage = "";

    private List<TabInfo> tabs = new()
    {
        new TabInfo { Id = "general", Name = "General", Icon = "<circle cx=\"12\" cy=\"12\" r=\"3\"/><path d=\"M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24\"/>" },
        new TabInfo { Id = "interface", Name = "Interface", Icon = "<rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" ry=\"2\"/><line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\"/><line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\"/>" },
        new TabInfo { Id = "connections", Name = "Connections", Icon = "<path d=\"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71\"/><path d=\"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71\"/>" },
        new TabInfo { Id = "personalisation", Name = "Personalisation", Icon = "<circle cx=\"12\" cy=\"12\" r=\"3\"/><path d=\"M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83\"/>" },
        new TabInfo { Id = "account", Name = "Account", Icon = "<path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"/><circle cx=\"12\" cy=\"7\" r=\"4\"/>" },
        new TabInfo { Id = "usage", Name = "Usage", Icon = "<line x1=\"12\" y1=\"20\" x2=\"12\" y2=\"10\"/><line x1=\"18\" y1=\"20\" x2=\"18\" y2=\"4\"/><line x1=\"6\" y1=\"20\" x2=\"6\" y2=\"16\"/>" }
    };

    private void SelectTab(string tabId)
    {
        activeTab = tabId;
    }

    private async Task HandleOverlayClick()
    {
        await Close();
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleCancel()
    {
        await Close();
    }

    private async Task HandleSave()
    {
        isSaving = true;
        errorMessage = "";

        try
        {
            // TODO: Implement actual save logic
            await Task.Delay(1000); // Simulate API call
            await Close();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save settings: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void HandleReset()
    {
        // TODO: Add confirmation dialog
        // TODO: Implement reset logic
    }

    public class TabInfo
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
    }
}
