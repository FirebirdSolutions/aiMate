@page "/"
@using Fluxor
@using AiMate.Web.Store.Chat
@using AiMate.Core.Enums
@using AiMate.Core.Plugins
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@rendermode InteractiveServer
@inject IState<ChatState> ChatState
@inject IDispatcher Dispatcher

<PageTitle>aiMate - Your AI Mate</PageTitle>

<div class="chat-messages">
    @if (ActiveConversation == null || !ActiveConversation.Messages.Any())
    {
        {{!-- Welcome message when no conversation --}}
        <div class="chat-message fade-in">
            <div class="chat-message-avatar assistant">AI</div>
            <div class="chat-message-content">
                <div class="chat-message-header">
                    <span class="chat-message-role">aiMate</span>
                    <span class="chat-message-time">Just now</span>
                </div>
                <div class="chat-message-body">
                    <MarkdownRenderer Content="@_welcomeMessage" />
                </div>
            </div>
        </div>
    }
    else
    {
        @foreach (var message in ActiveConversation.Messages)
        {
            <div class="chat-message fade-in">
                <div class="chat-message-avatar @(message.Role == MessageRole.User ? "user" : "assistant")">
                    @(message.Role == MessageRole.User ? "U" : "AI")
                </div>
                <div class="chat-message-content">
                    <div class="chat-message-header">
                        <span class="chat-message-role">@(message.Role == MessageRole.User ? "You" : "aiMate")</span>
                        <span class="chat-message-time">@message.CreatedAt.ToString("HH:mm")</span>
                    </div>
                    <div class="chat-message-body">
                        <MarkdownRenderer Content="@message.Content" />
                    </div>
                    <MessageActions Message="@message" OnActionClick="@HandlePluginAction" />
                </div>
            </div>
        }

        @if (ChatState.Value.IsStreaming)
        {
            <div class="chat-streaming-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        }
    }
</div>

<div class="chat-input-container">
    <div class="chat-input-wrapper">
        <button class="btn btn-icon" title="Attach file">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
        </button>

        <textarea
            class="chat-input"
            placeholder="Send a Message"
            rows="1"
            value="@ChatState.Value.CurrentInput"
            @oninput="@((e) => Dispatcher.Dispatch(new UpdateInputAction(e.Value?.ToString() ?? string.Empty)))"
            @onkeydown="@HandleKeyDown"
            disabled="@ChatState.Value.IsStreaming"></textarea>

        <button class="btn btn-primary" @onclick="SendMessage" disabled="@(string.IsNullOrWhiteSpace(ChatState.Value.CurrentInput) || ChatState.Value.IsStreaming)">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        </button>
    </div>
</div>

@code {
    private const string _welcomeMessage = @"# Kia ora! I'm aiMate ðŸ‡³ðŸ‡¿

Your AI mate from New Zealand. Free, open-source, and built for people - not corporates.

**What makes me different:**
- I talk like a real Kiwi, not a corporate robot
- Your data stays in NZ
- Truly open source (MIT license)
- No gatekeeping, no bullshit

What can I help you with today, mate?";

    private Core.Entities.Conversation? ActiveConversation =>
        ChatState.Value.ActiveConversationId.HasValue
            ? ChatState.Value.Conversations.GetValueOrDefault(ChatState.Value.ActiveConversationId.Value)
            : null;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Create default conversation if none exists
        if (!ChatState.Value.Conversations.Any())
        {
            Dispatcher.Dispatch(new CreateConversationAction("New Chat"));
        }

        // Load available models
        Dispatcher.Dispatch(new LoadModelsAction());
    }

    private void SendMessage()
    {
        if (string.IsNullOrWhiteSpace(ChatState.Value.CurrentInput) || ChatState.Value.IsStreaming)
            return;

        var conversationId = ChatState.Value.ActiveConversationId ?? CreateNewConversation();
        var content = ChatState.Value.CurrentInput;

        Dispatcher.Dispatch(new SendMessageAction(conversationId, content));
        Dispatcher.Dispatch(new ClearInputAction());
    }

    private Guid CreateNewConversation()
    {
        var action = new CreateConversationAction("New Chat");
        Dispatcher.Dispatch(action);
        // In real implementation, wait for success action
        return Guid.NewGuid();
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !ChatState.Value.IsStreaming)
        {
            SendMessage();
        }
    }

    private void EditMessage(Guid messageId)
    {
        // IMPLEMENTATION NEEDED: Dispatch EditMessageAction to enable editing mode
        // Example: Dispatcher.Dispatch(new EditMessageAction(messageId));
    }

    private async Task CopyMessage(string content)
    {
        // IMPLEMENTATION NEEDED: Use Clipboard API via JS interop
        // await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", content);
    }

    private void RateMessage(Guid messageId, bool isPositive)
    {
        // IMPLEMENTATION NEEDED: Dispatch RateMessageAction to save rating
        // Example: Dispatcher.Dispatch(new RateMessageAction(messageId, isPositive ? 1 : -1));
    }

    private void ContinueGeneration(Guid messageId)
    {
        // IMPLEMENTATION NEEDED: Dispatch ContinueGenerationAction to extend response
        // Example: Dispatcher.Dispatch(new ContinueGenerationAction(messageId));
    }

    private void RegenerateMessage(Guid messageId)
    {
        // IMPLEMENTATION NEEDED: Dispatch RegenerateMessageAction to regenerate response
        // Example: Dispatcher.Dispatch(new RegenerateMessageAction(messageId));
    }

    private void HandlePluginAction(MessageActionButton action)
    {
        // Handle plugin action based on the action handler
        switch (action.OnClickHandler)
        {
            case "handleEditMessage":
                // IMPLEMENTATION NEEDED: Extract messageId from action.Context and call EditMessage
                // Example: if (action.Context.TryGetValue("messageId", out var id)) EditMessage(Guid.Parse(id));
                break;

            case "handleRegenerateMessage":
                // IMPLEMENTATION NEEDED: Extract messageId and call RegenerateMessage
                // Example: if (action.Context.TryGetValue("messageId", out var id)) RegenerateMessage(Guid.Parse(id));
                break;

            case "handleShareMessage":
                // IMPLEMENTATION NEEDED: Show ShareConversationDialog
                // Example: await DialogService.ShowAsync<ShareConversationDialog>("Share Message");
                break;

            case "handleDeleteMessage":
                // IMPLEMENTATION NEEDED: Dispatch DeleteMessageAction after confirmation
                // Example: Dispatcher.Dispatch(new DeleteMessageAction(messageId));
                break;

            case "handleThumbsUp":
                // IMPLEMENTATION NEEDED: Extract messageId and call RateMessage(messageId, true)
                // Example: if (action.Context.TryGetValue("messageId", out var id)) RateMessage(Guid.Parse(id), true);
                break;

            case "handleThumbsDown":
                // IMPLEMENTATION NEEDED: Extract messageId and call RateMessage(messageId, false)
                // Example: if (action.Context.TryGetValue("messageId", out var id)) RateMessage(Guid.Parse(id), false);
                break;

            default:
                // For other custom actions, log for now
                Console.WriteLine($"Plugin action triggered: {action.Id} - {action.Label}");
                break;
        }
    }
}

<style>
    .chat-streaming-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 24px;
        align-items: center;
    }

    .chat-streaming-indicator .dot {
        width: 8px;
        height: 8px;
        background-color: var(--primary-color);
        border-radius: 50%;
        animation: pulse 1.4s infinite ease-in-out;
    }

    .chat-streaming-indicator .dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .chat-streaming-indicator .dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @@keyframes pulse {
        0%, 60%, 100% {
            opacity: 0.3;
            transform: scale(0.8);
        }
        30% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
    }
</style>
